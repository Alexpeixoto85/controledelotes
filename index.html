
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reserva da Foz - Sistema Integrado</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Importar fontes do Google -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&family=Open+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
    
    <style>
        :root {
            /* Paleta Amazônia */
            --primary-color: #1b4d3e;      /* Verde Floresta */
            --primary-light: #2d6a4f;
            --secondary-color: #8c6239;    /* Terra */
            --bg-color: #f1f8f4;           /* Menta Suave */
            --card-bg: #ffffff;
            
            /* Status */
            --success-color: #40916c;
            --danger-color: #bc4749;
            
            --text-dark: #1f2421;
            --border-radius: 12px;
            --box-shadow: 0 6px 15px rgba(27, 77, 62, 0.15);
            --transition: all 0.3s ease;
        }
        
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            font-family: 'Open Sans', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-dark);
            padding: 20px;
            background-image: radial-gradient(#1b4d3e 0.5px, transparent 0.5px);
            background-size: 20px 20px;
        }
        
        .container { max-width: 1400px; margin: 0 auto; }
        
        /* Header - Nova Identidade Visual */
        header {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-light));
            padding: 25px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            margin-bottom: 20px;
            text-align: center;
            color: white;
            position: relative;
            overflow: hidden;
        }
        
        .logo-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }
        
        .logo-main {
            font-family: 'Montserrat', sans-serif;
            font-weight: 800;
            font-size: 2.8rem;
            letter-spacing: 2px;
            text-transform: uppercase;
            line-height: 1;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }
        
        .logo-subtitle {
            font-family: 'Montserrat', sans-serif;
            font-weight: 500;
            font-size: 1.2rem;
            letter-spacing: 4px;
            margin-top: 5px;
            opacity: 0.9;
        }
        
        .logo-location {
            font-family: 'Open Sans', sans-serif;
            font-weight: 400;
            font-size: 0.9rem;
            margin-top: 8px;
            padding: 5px 15px;
            background: rgba(255,255,255,0.2);
            border-radius: 20px;
            display: inline-block;
        }
        
        .header-decoration {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 10px;
            background: linear-gradient(90deg, #8c6239, #a87c52, #8c6239);
            opacity: 0.8;
        }
        
        /* Layout Grid */
        .main-grid {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 20px;
            transition: var(--transition);
        }
        
        .main-grid.simplified {
            grid-template-columns: 1fr;
        }

        .card {
            background-color: var(--card-bg);
            padding: 18px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            margin-bottom: 20px;
            border-left: 5px solid var(--primary-color);
            transition: var(--transition);
        }
        
        .card.hidden {
            display: none;
        }
        
        .card h2 {
            color: var(--primary-color);
            margin-bottom: 12px;
            font-size: 1.1rem;
            font-weight: 700;
            border-bottom: 2px solid #eee;
            padding-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-family: 'Montserrat', sans-serif;
        }

        /* Botões */
        button {
            padding: 8px;
            font-size: 12px;
            font-weight: 600;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            width: 100%;
            font-family: 'Montserrat', sans-serif;
        }
        .btn-primary { background-color: var(--primary-color); color: white; }
        .btn-primary:hover { background-color: var(--primary-light); transform: translateY(-2px); }
        .btn-success { background-color: var(--success-color); color: white; }
        .btn-danger { background-color: var(--danger-color); color: white; }
        .btn-outline { border: 2px solid var(--primary-color); color: var(--primary-color); background: transparent; }
        .btn-outline:hover { background: var(--primary-color); color: white; }
        .btn-warning { background-color: #e9b949; color: white; }
        .btn-warning:hover { background-color: #d4a235; }
        
        /* Botão pequeno para ação rápida */
        .btn-sm { padding: 4px 8px; font-size: 0.75rem; width: auto; margin: 0; }
        .btn-action-card { 
            border: 1px solid #ccc; color: #555; background: #f8f9fa; 
            position: absolute; bottom: 12px; right: 12px; z-index: 5;
        }
        .btn-action-card:hover { background: #e2e6ea; color: #000; }

        /* Inputs */
        .file-input-wrapper { position: relative; margin-bottom: 12px; }
        input[type="file"] {
            width: 100%; padding: 8px; border: 2px dashed var(--primary-light);
            border-radius: var(--border-radius); background: #f9fbf9; cursor: pointer;
            font-size: 0.85rem;
        }
        .search-bar { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 15px; }
        .search-input { flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 0.85rem; }
        
        /* Formulários */
        .form-group { margin-bottom: 12px; }
        .form-label { display: block; font-size: 0.8rem; margin-bottom: 4px; color: #555; font-weight: 600; font-family: 'Montserrat', sans-serif; }
        .form-control { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 0.85rem; }
        textarea.form-control { min-height: 80px; resize: vertical; }

        /* Gráficos */
        .chart-wrapper { position: relative; height: 170px; margin-bottom: 15px; }

        /* Cards de Lotes */
        #resultsContainer {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 15px;
        }
        .lot-card {
            background: white; border-radius: var(--border-radius);
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); transition: var(--transition);
            border: 1px solid #eee; cursor: pointer; position: relative;
            display: flex; flex-direction: column;
            padding-bottom: 45px;
        }
        .lot-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
        .lot-card-header { padding: 12px; color: white; display: flex; justify-content: space-between; border-radius: 10px 10px 0 0; }
        .lot-card.disponivel .lot-card-header { background: var(--success-color); }
        .lot-card.vendido .lot-card-header { background: var(--danger-color); }
        .lot-card.vendido { opacity: 0.85; }
        
        .lot-body { padding: 12px; font-size: 0.8rem; flex-grow: 1; }
        .lot-info-row { display: flex; justify-content: space-between; margin-bottom: 5px; border-bottom: 1px dashed #eee; padding-bottom: 3px; }
        
        /* MODAL (Ficha Técnica) */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); z-index: 1000; align-items: center; justify-content: center;
            backdrop-filter: blur(3px);
        }
        .modal-content {
            background: white; width: 95%; max-width: 800px; max-height: 90vh;
            border-radius: 12px; overflow-y: auto; position: relative;
            box-shadow: 0 20px 50px rgba(0,0,0,0.3); animation: slideUp 0.3s ease;
        }
        @keyframes slideUp { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        .modal-header {
            background: var(--primary-color); color: white; padding: 15px;
            display: flex; justify-content: space-between; align-items: center;
            position: sticky; top: 0;
        }
        .modal-body { padding: 18px; }
        .detail-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(170px, 1fr)); 
            gap: 10px; 
        }
        .detail-item { background: #f8f9fa; padding: 8px; border-radius: 6px; }
        .detail-label { font-size: 0.7rem; color: #666; display: block; }
        .detail-value { font-size: 0.85rem; font-weight: bold; color: var(--primary-color); display: block; }
        .close-modal { background: none; border: none; color: white; font-size: 1.3rem; cursor: pointer; width: auto; margin: 0; }

        /* Status Badge */
        .status-badge {
            background: rgba(255,255,255,0.9); color: #333;
            padding: 3px 7px; border-radius: 10px; font-size: 0.65rem; font-weight: bold;
        }

        /* Sales Input Area */
        .sales-input-area { background-color: #ffedea; border: 1px solid #ffcccb; padding: 12px; border-radius: 10px; margin-top: 15px; }
        .sales-input { width: 100%; padding: 8px; margin-bottom: 8px; border: 1px solid #eeb4b4; border-radius: 6px; font-size: 0.85rem; }

        /* Valor Médio */
        .avg-value-card {
            background: linear-gradient(135deg, #8c6239, #a87c52);
            color: white;
            text-align: center;
            padding: 15px;
            border-radius: var(--border-radius);
            margin-bottom: 18px;
            box-shadow: var(--box-shadow);
        }
        .avg-value-card h3 {
            font-size: 0.9rem;
            margin-bottom: 8px;
            opacity: 0.9;
        }
        .avg-value-card .value {
            font-size: 1.4rem;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .avg-value-card .description {
            font-size: 0.7rem;
            opacity: 0.8;
        }

        /* Backup Section */
        .backup-section {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px dashed #ddd;
        }

        /* Toggle Switch */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: var(--primary-color);
        }

        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }

        .toggle-label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.8rem;
            color: var(--text-dark);
        }

        /* Mode Toggle Card */
        .mode-toggle-card {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border: 1px solid #dee2e6;
            padding: 12px 15px;
            border-radius: var(--border-radius);
            margin-bottom: 18px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .mode-toggle-card .toggle-label {
            font-weight: 600;
            color: var(--primary-color);
        }

        /* Ficha Individual para Impressão */
        .print-ficha {
            display: none;
            background: white;
            padding: 25px;
            max-width: 800px;
            margin: 0 auto;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .ficha-header {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-light));
            color: white;
            padding: 20px;
            border-radius: 10px 10px 0 0;
            text-align: center;
            margin-bottom: 20px;
        }

        .ficha-title {
            font-size: 1.8rem;
            margin-bottom: 5px;
            font-family: 'Montserrat', sans-serif;
            font-weight: 700;
        }

        .ficha-subtitle {
            font-size: 1rem;
            opacity: 0.9;
        }

        .ficha-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 25px;
        }

        .ficha-section {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid var(--primary-color);
        }

        .ficha-section h3 {
            color: var(--primary-color);
            margin-bottom: 12px;
            font-size: 1.1rem;
            border-bottom: 1px solid #ddd;
            padding-bottom: 5px;
            font-family: 'Montserrat', sans-serif;
        }

        .ficha-info {
            display: grid;
            gap: 8px;
        }

        .ficha-info-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px dashed #eee;
        }

        .ficha-label {
            font-weight: 600;
            color: #555;
        }

        .ficha-value {
            font-weight: bold;
            color: var(--primary-color);
        }

        .ficha-highlight {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-light));
            color: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            margin: 15px 0;
        }

        .ficha-total {
            font-size: 1.5rem;
            font-weight: bold;
            margin: 5px 0;
        }

        .ficha-footer {
            text-align: center;
            margin-top: 25px;
            padding-top: 15px;
            border-top: 2px solid #eee;
            color: #666;
            font-size: 0.8rem;
        }

        .ficha-status {
            display: inline-block;
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: bold;
            margin: 10px 0;
        }

        .status-disponivel {
            background-color: var(--success-color);
            color: white;
        }

        .status-vendido {
            background-color: var(--danger-color);
            color: white;
        }

        /* Clientes */
        .clientes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .cliente-card {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            padding: 15px;
            border-left: 4px solid var(--primary-color);
            transition: var(--transition);
        }

        .cliente-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .cliente-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .cliente-nome {
            font-weight: bold;
            color: var(--primary-color);
            font-size: 1rem;
            font-family: 'Montserrat', sans-serif;
        }

        .cliente-contato {
            font-size: 0.8rem;
            color: #666;
            margin-bottom: 5px;
        }

        .cliente-lote {
            font-size: 0.8rem;
            margin-bottom: 8px;
            padding: 5px 10px;
            background: #f1f8f4;
            border-radius: 4px;
            display: inline-block;
        }

        .cliente-obs {
            font-size: 0.8rem;
            color: #555;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px dashed #eee;
        }

        .cliente-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }

        .cliente-actions button {
            flex: 1;
            padding: 6px;
            font-size: 0.7rem;
        }

        /* Painel de Clientes */
        .clientes-panel {
            display: none;
            margin-top: 20px;
        }

        .clientes-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .clientes-title {
            color: var(--primary-color);
            font-size: 1.3rem;
            font-weight: bold;
            font-family: 'Montserrat', sans-serif;
        }

        /* Abas */
        .tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 15px;
        }

        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: var(--transition);
            font-weight: 600;
            font-family: 'Montserrat', sans-serif;
        }

        .tab.active {
            border-bottom-color: var(--primary-color);
            color: var(--primary-color);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Mensagem de aviso */
        .warning-message {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 15px;
            font-size: 0.8rem;
        }

        @media (max-width: 900px) { 
            .main-grid { grid-template-columns: 1fr; } 
            .detail-grid { grid-template-columns: 1fr; } 
            
            .mode-toggle-card {
                flex-direction: column;
                gap: 10px;
                text-align: center;
            }
            
            .mode-toggle-card .toggle-label {
                font-size: 0.9rem;
            }

            .ficha-content {
                grid-template-columns: 1fr;
            }

            .clientes-grid {
                grid-template-columns: 1fr;
            }
            
            .logo-main {
                font-size: 2rem;
            }
            
            .logo-subtitle {
                font-size: 1rem;
                letter-spacing: 2px;
            }
        }
    </style>
</head>
<body>

    <div class="container">
        <header>
            <div class="logo-container">
                <div class="logo-main">RESERVA DA FOZ</div>
                <div class="logo-subtitle">ROTA DOS MILAGRES - ALAGOAS</div>
                <div class="logo-location">Gestão de Estoque e Clientes</div>
            </div>
            <div class="header-decoration"></div>
        </header>

        <!-- Card de Controle de Modo Simplificado -->
        <div class="mode-toggle-card">
            <div class="toggle-label">
                <i class="fas fa-eye-slash"></i> Modo Simplificado
            </div>
            <label class="toggle-switch">
                <input type="checkbox" id="simplifiedModeToggle">
                <span class="toggle-slider"></span>
            </label>
        </div>

        <!-- Abas para navegação -->
        <div class="tabs">
            <div class="tab active" data-tab="lotes">Lotes</div>
            <div class="tab" data-tab="clientes">Clientes</div>
        </div>

        <!-- Conteúdo da aba Lotes -->
        <div class="tab-content active" id="lotes-tab">
            <div class="main-grid" id="mainGrid">
                <div class="controls-column" id="controlsColumn">
                    <div class="card config-card">
                        <h2><i class="fas fa-file-import"></i> Dados</h2>
                        <div class="file-input-wrapper">
                            <input type="file" id="pdfFileInput" accept=".pdf">
                        </div>
                        <button id="importPdfButton" class="btn-primary"><i class="fas fa-cog"></i> Processar PDF</button>
                        <div id="loadingIndicator" style="display:none; text-align:center; margin-top:8px; color:#666; font-size:0.8rem;">Lendo arquivo...</div>
                    </div>

                    <!-- Card de Valor Médio Geral -->
                    <div class="avg-value-card">
                        <h3><i class="fas fa-chart-line"></i> Valor Médio Geral</h3>
                        <div class="value" id="avgTotalValue">R$ 0,00</div>
                        <div class="description">Média de valor dos lotes</div>
                    </div>

                    <div class="card">
                        <h2><i class="fas fa-chart-pie"></i> Disponibilidade Total</h2>
                        <div class="chart-wrapper" style="height: 150px;">
                            <canvas id="quantityChart"></canvas>
                        </div>
                        <div style="display:flex; justify-content:space-between; font-size:0.8rem; padding-top:8px; border-top:1px dashed #eee;">
                            <span>Total: <strong id="totalCount">0</strong></span>
                            <span style="color:var(--success-color)">Disp: <strong id="availCount">0</strong></span>
                            <span style="color:var(--danger-color)">Vend: <strong id="soldCount">0</strong></span>
                        </div>
                    </div>

                    <div class="card">
                        <h2><i class="fas fa-building"></i> Disponíveis por Quadra</h2>
                        <div class="chart-wrapper" style="height: 180px;">
                            <canvas id="quadraChart"></canvas>
                        </div>
                        <p style="font-size:0.7rem; text-align:center; color:#666;">Quantidade de lotes livres em cada quadra</p>
                    </div>

                    <div class="card">
                        <h2><i class="fas fa-chart-line"></i> Financeiro (VGV)</h2>
                        <div class="chart-wrapper" style="height: 150px;">
                            <canvas id="financialChart"></canvas>
                        </div>
                        <p style="font-size:0.7rem; text-align:center; color:#666;">Potencial de Vendas vs. Realizado</p>
                    </div>

                    <div class="card config-card">
                        <h2><i class="fas fa-tag"></i> Marcar em Massa</h2>
                        <div class="sales-input-area">
                            <p style="font-size:0.7rem; margin-bottom:5px;">Itens vermelhos (separados por vírgula):</p>
                            <input type="text" id="soldItemsInput" class="sales-input" placeholder="Ex: 1, 5, 12, 34...">
                            <button id="markSoldButton" class="btn-danger">Marcar Vendidos</button>
                        </div>
                    </div>

                    <div class="card config-card">
                        <h2><i class="fas fa-file-export"></i> Ações</h2>
                        <button id="downloadFullPdf" class="btn-success"><i class="fas fa-file-pdf"></i> Exportar PDF Completo</button>
                        
                        <div class="backup-section">
                            <h3 style="font-size:0.85rem; margin-bottom:8px; color:#666;"><i class="fas fa-database"></i> Backup do Sistema</h3>
                            <button id="backupButton" class="btn-warning"><i class="fas fa-download"></i> Fazer Backup</button>
                            <button id="restoreButton" class="btn-outline" style="margin-top:6px;"><i class="fas fa-upload"></i> Restaurar Backup</button>
                            <input type="file" id="restoreFileInput" accept=".json" style="display:none;">
                        </div>
                        
                        <button id="clearButton" class="btn-outline" style="margin-top:8px;"><i class="fas fa-trash"></i> Limpar Sistema</button>
                    </div>
                </div>

                <div class="results-column">
                    <div class="card">
                        <h2><i class="fas fa-list"></i> Catálogo de Lotes</h2>
                        <div class="search-bar">
                            <input type="text" id="searchLote" class="search-input" placeholder="Buscar Lote...">
                            <input type="text" id="searchQuadra" class="search-input" placeholder="Quadra...">
                            <select id="filterStatus" class="search-input">
                                <option value="todos">Todos</option>
                                <option value="disponivel">Disponíveis</option>
                                <option value="vendido">Vendidos</option>
                            </select>
                            <select id="sortSelect" class="search-input">
                                <option value="quadra">Ordenar por Quadra</option>
                                <option value="valor">Ordenar por Valor</option>
                            </select>
                        </div>
                        <div id="resultsContainer">
                            <div style="grid-column:1/-1; text-align:center; padding:30px; color:#aaa;">
                                <i class="fas fa-folder-open" style="font-size:2.5rem; margin-bottom:8px;"></i>
                                <p>Importe o PDF para começar.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Conteúdo da aba Clientes -->
        <div class="tab-content" id="clientes-tab">
            <div class="clientes-panel" id="clientesPanel">
                <div class="clientes-header">
                    <h2 class="clientes-title"><i class="fas fa-users"></i> Gestão de Clientes</h2>
                    <button id="novoClienteBtn" class="btn-primary" style="width: auto;">
                        <i class="fas fa-plus"></i> Novo Cliente
                    </button>
                </div>

                <div class="card">
                    <h2><i class="fas fa-users"></i> Clientes Cadastrados</h2>
                    <div class="search-bar">
                        <input type="text" id="searchCliente" class="search-input" placeholder="Buscar cliente...">
                        <select id="filterClienteLote" class="search-input">
                            <option value="todos">Todos os lotes</option>
                        </select>
                    </div>
                    <div id="clientesContainer" class="clientes-grid">
                        <div style="grid-column:1/-1; text-align:center; padding:20px; color:#aaa;">
                            <i class="fas fa-user-plus" style="font-size:2rem; margin-bottom:8px;"></i>
                            <p>Nenhum cliente cadastrado ainda.</p>
                            <button id="novoClienteEmptyBtn" class="btn-primary" style="width: auto; margin-top: 10px;">
                                <i class="fas fa-plus"></i> Cadastrar Primeiro Cliente
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Detalhes do Lote -->
    <div class="modal-overlay" id="detailModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Detalhes</h3>
                <button class="close-modal" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="detail-grid">
                    <div class="detail-item">
                        <span class="detail-label">Quadra / Lote</span>
                        <span class="detail-value" id="mQuadraLote">-</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Item Tabela</span>
                        <span class="detail-value" id="mItem">-</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Tamanho (m²)</span>
                        <span class="detail-value" id="mTam">-</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Valor do m²</span>
                        <span class="detail-value" id="mM2">-</span>
                    </div>
                    <div class="detail-item" style="grid-column: 1/-1; background: #e8f5e9; border:1px solid #c8e6c9;">
                        <span class="detail-label">Valor Total</span>
                        <span class="detail-value" id="mTotal" style="font-size:1.1rem; color:#2e7d32;">-</span>
                    </div>
                    
                    <div class="detail-item"><span class="detail-label">Sinal</span><span class="detail-value" id="mSinal">-</span></div>
                    <div class="detail-item"><span class="detail-label">Sinal à Vista</span><span class="detail-value" id="mSinalVista">-</span></div>
                    <div class="detail-item"><span class="detail-label">Reserva</span><span class="detail-value" id="mReserva">-</span></div>
                    <div class="detail-item"><span class="detail-label">Saldo à Vista</span><span class="detail-value" id="mSaldoVista">-</span></div>
                    <div class="detail-item"><span class="detail-label">Saldo em 2x</span><span class="detail-value" id="mSaldo2x">-</span></div>
                    <div class="detail-item"><span class="detail-label">Saldo em 3x</span><span class="detail-value" id="mSaldo3x">-</span></div>
                    <div class="detail-item"><span class="detail-label">Saldo 60 meses</span><span class="detail-value" id="mSaldo60">-</span></div>
                    <div class="detail-item"><span class="detail-label">120 Meses</span><span class="detail-value" id="m120">-</span></div>
                    <div class="detail-item"><span class="detail-label">156 Meses</span><span class="detail-value" id="m156">-</span></div>
                    <div class="detail-item"><span class="detail-label">160 Meses</span><span class="detail-value" id="m160">-</span></div>
                </div>
                <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: center;">
                    <button id="downloadFichaButton" class="btn-success" style="width: auto;">
                        <i class="fas fa-download"></i> Baixar Ficha em PDF
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Cadastro de Cliente -->
    <div class="modal-overlay" id="clienteModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="clienteModalTitle">Cadastrar Novo Cliente</h3>
                <button class="close-modal" onclick="closeClienteModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="warning-message">
                    <i class="fas fa-info-circle"></i> <strong>Atenção:</strong> Só é possível relacionar clientes a lotes disponíveis. Lotes vendidos não aparecerão na lista.
                </div>
                
                <div class="form-group">
                    <label class="form-label">Nome Completo *</label>
                    <input type="text" id="clienteNome" class="form-control" placeholder="Nome do cliente">
                </div>
                <div class="form-group">
                    <label class="form-label">Telefone</label>
                    <input type="text" id="clienteTelefone" class="form-control" placeholder="(00) 00000-0000">
                </div>
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" id="clienteEmail" class="form-control" placeholder="email@exemplo.com">
                </div>
                <div class="form-group">
                    <label class="form-label">Lote de Interesse *</label>
                    <select id="clienteLote" class="form-control">
                        <option value="">Selecione um lote disponível</option>
                    </select>
                    <div id="loteInfo" style="margin-top: 5px; font-size: 0.75rem; color: #666; display: none;">
                        <span id="loteDetails"></span>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Observações</label>
                    <textarea id="clienteObservacoes" class="form-control" placeholder="Observações sobre o cliente ou interesse..."></textarea>
                </div>
                <div style="margin-top: 20px; display: flex; gap: 10px;">
                    <button id="salvarCliente" class="btn-success">
                        <i class="fas fa-save"></i> Salvar Cliente
                    </button>
                    <button class="btn-outline" onclick="closeClienteModal()">
                        <i class="fas fa-times"></i> Cancelar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Ficha para Impressão/PDF (oculta) -->
    <div class="print-ficha" id="printFicha">
        <div class="ficha-header">
            <h1 class="ficha-title">RESERVA DA FOZ</h1>
            <div class="ficha-subtitle">Ficha Técnica do Lote</div>
        </div>

        <div class="ficha-content">
            <div class="ficha-section">
                <h3><i class="fas fa-map-marker-alt"></i> Identificação</h3>
                <div class="ficha-info">
                    <div class="ficha-info-item">
                        <span class="ficha-label">Quadra / Lote:</span>
                        <span class="ficha-value" id="fichaQuadraLote">-</span>
                    </div>
                    <div class="ficha-info-item">
                        <span class="ficha-label">Item Tabela:</span>
                        <span class="ficha-value" id="fichaItem">-</span>
                    </div>
                    <div class="ficha-info-item">
                        <span class="ficha-label">Área Total:</span>
                        <span class="ficha-value" id="fichaArea">- m²</span>
                    </div>
                    <div class="ficha-info-item">
                        <span class="ficha-label">Valor do m²:</span>
                        <span class="ficha-value" id="fichaM2">-</span>
                    </div>
                </div>
            </div>

            <div class="ficha-section">
                <h3><i class="fas fa-info-circle"></i> Status</h3>
                <div class="ficha-info">
                    <div class="ficha-info-item">
                        <span class="ficha-label">Situação:</span>
                        <span class="ficha-value" id="fichaStatus">-</span>
                    </div>
                    <div class="ficha-info-item">
                        <span class="ficha-label">Data da Ficha:</span>
                        <span class="ficha-value" id="fichaData">-</span>
                    </div>
                </div>
                <div id="fichaStatusBadge" class="ficha-status status-disponivel">DISPONÍVEL</div>
            </div>

            <div class="ficha-section" style="grid-column: 1 / -1;">
                <h3><i class="fas fa-money-bill-wave"></i> Valores Principais</h3>
                <div class="ficha-highlight">
                    <div>Valor Total do Lote</div>
                    <div class="ficha-total" id="fichaValorTotal">-</div>
                </div>
            </div>

            <div class="ficha-section">
                <h3><i class="fas fa-handshake"></i> Condições de Pagamento</h3>
                <div class="ficha-info">
                    <div class="ficha-info-item">
                        <span class="ficha-label">Sinal:</span>
                        <span class="ficha-value" id="fichaSinal">-</span>
                    </div>
                    <div class="ficha-info-item">
                        <span class="ficha-label">Sinal à Vista:</span>
                        <span class="ficha-value" id="fichaSinalVista">-</span>
                    </div>
                    <div class="ficha-info-item">
                        <span class="ficha-label">Reserva:</span>
                        <span class="ficha-value" id="fichaReserva">-</span>
                    </div>
                    <div class="ficha-info-item">
                        <span class="ficha-label">Saldo à Vista:</span>
                        <span class="ficha-value" id="fichaSaldoVista">-</span>
                    </div>
                </div>
            </div>

            <div class="ficha-section">
                <h3><i class="fas fa-calendar-alt"></i> Parcelamento</h3>
                <div class="ficha-info">
                    <div class="ficha-info-item">
                        <span class="ficha-label">Saldo em 2x:</span>
                        <span class="ficha-value" id="fichaSaldo2x">-</span>
                    </div>
                    <div class="ficha-info-item">
                        <span class="ficha-label">Saldo em 3x:</span>
                        <span class="ficha-value" id="fichaSaldo3x">-</span>
                    </div>
                    <div class="ficha-info-item">
                        <span class="ficha-label">Saldo 60 meses:</span>
                        <span class="ficha-value" id="fichaSaldo60">-</span>
                    </div>
                    <div class="ficha-info-item">
                        <span class="ficha-label">120 Meses:</span>
                        <span class="ficha-value" id="ficha120">-</span>
                    </div>
                    <div class="ficha-info-item">
                        <span class="ficha-label">156 Meses:</span>
                        <span class="ficha-value" id="ficha156">-</span>
                    </div>
                    <div class="ficha-info-item">
                        <span class="ficha-label">160 Meses:</span>
                        <span class="ficha-value" id="ficha160">-</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="ficha-footer">
            <p>RESERVA DA FOZ - Sistema de Gestão de Lotes | Gerado em <span id="fichaGeradoEm">-</span></p>
            <p>www.reservadafoz.com.br | contato@reservadafoz.com.br</p>
        </div>
    </div>

    <!-- Ficha do Cliente para Impressão/PDF (oculta) -->
    <div class="print-ficha" id="printFichaCliente">
        <div class="ficha-header">
            <h1 class="ficha-title">RESERVA DA FOZ</h1>
            <div class="ficha-subtitle">Ficha do Cliente</div>
        </div>

        <div class="ficha-content">
            <div class="ficha-section" style="grid-column: 1 / -1;">
                <h3><i class="fas fa-user"></i> Dados do Cliente</h3>
                <div class="ficha-info">
                    <div class="ficha-info-item">
                        <span class="ficha-label">Nome:</span>
                        <span class="ficha-value" id="fichaClienteNome">-</span>
                    </div>
                    <div class="ficha-info-item">
                        <span class="ficha-label">Telefone:</span>
                        <span class="ficha-value" id="fichaClienteTelefone">-</span>
                    </div>
                    <div class="ficha-info-item">
                        <span class="ficha-label">Email:</span>
                        <span class="ficha-value" id="fichaClienteEmail">-</span>
                    </div>
                    <div class="ficha-info-item">
                        <span class="ficha-label">Data de Cadastro:</span>
                        <span class="ficha-value" id="fichaClienteData">-</span>
                    </div>
                </div>
            </div>

            <div class="ficha-section" style="grid-column: 1 / -1;">
                <h3><i class="fas fa-home"></i> Lote de Interesse</h3>
                <div class="ficha-info">
                    <div class="ficha-info-item">
                        <span class="ficha-label">Quadra / Lote:</span>
                        <span class="ficha-value" id="fichaClienteLote">-</span>
                    </div>
                    <div class="ficha-info-item">
                        <span class="ficha-label">Área Total:</span>
                        <span class="ficha-value" id="fichaClienteArea">- m²</span>
                    </div>
                    <div class="ficha-info-item">
                        <span class="ficha-label">Valor Total:</span>
                        <span class="ficha-value" id="fichaClienteValor">-</span>
                    </div>
                </div>
            </div>

            <div class="ficha-section" style="grid-column: 1 / -1;">
                <h3><i class="fas fa-sticky-note"></i> Observações</h3>
                <div style="padding: 10px; background: #f8f9fa; border-radius: 6px; min-height: 80px;">
                    <p id="fichaClienteObservacoes">-</p>
                </div>
            </div>
        </div>

        <div class="ficha-footer">
            <p>RESERVA DA FOZ - Sistema de Gestão de Clientes | Gerado em <span id="fichaClienteGeradoEm">-</span></p>
            <p>www.reservadafoz.com.br | contato@reservadafoz.com.br</p>
        </div>
    </div>

    <script>
        // Desenvolvedor Alex Peixoto. Todos os Direitos Reservados
        
        document.addEventListener('DOMContentLoaded', () => {
            // Estado
            let database = [];
            let clientes = [];
            let charts = {};
            let currentLote = null;
            let currentCliente = null;
            let simplifiedMode = localStorage.getItem('simplifiedMode') === 'true';
            let editingClienteId = null;

            // Inicializar Modo Simplificado
            function initSimplifiedMode() {
                const toggle = document.getElementById('simplifiedModeToggle');
                const mainGrid = document.getElementById('mainGrid');
                const configCards = document.querySelectorAll('.config-card');
                
                toggle.checked = simplifiedMode;
                
                if (simplifiedMode) {
                    mainGrid.classList.add('simplified');
                    configCards.forEach(card => card.classList.add('hidden'));
                } else {
                    mainGrid.classList.remove('simplified');
                    configCards.forEach(card => card.classList.remove('hidden'));
                }
                
                toggle.addEventListener('change', function() {
                    simplifiedMode = this.checked;
                    localStorage.setItem('simplifiedMode', simplifiedMode);
                    
                    if (simplifiedMode) {
                        mainGrid.classList.add('simplified');
                        configCards.forEach(card => card.classList.add('hidden'));
                    } else {
                        mainGrid.classList.remove('simplified');
                        configCards.forEach(card => card.classList.remove('hidden'));
                    }
                });
            }

            // Inicializar Gráficos
            function initCharts() {
                // 1. Quantidade Geral
                const ctxQty = document.getElementById('quantityChart').getContext('2d');
                charts.qty = new Chart(ctxQty, {
                    type: 'doughnut',
                    data: {
                        labels: ['Disponíveis', 'Vendidos'],
                        datasets: [{ data: [0,0], backgroundColor: ['#40916c', '#bc4749'], borderWidth: 0 }]
                    },
                    options: { 
                        responsive: true, 
                        maintainAspectRatio: false, 
                        cutout: '60%', 
                        plugins: { legend: { display: false } } 
                    }
                });

                // 2. Lotes por Quadra
                const ctxQuadra = document.getElementById('quadraChart').getContext('2d');
                charts.quadra = new Chart(ctxQuadra, {
                    type: 'bar',
                    data: {
                        labels: [],
                        datasets: [{
                            label: 'Disponíveis',
                            data: [],
                            backgroundColor: '#2d6a4f',
                            borderRadius: 4
                        }]
                    },
                    options: {
                        responsive: true, 
                        maintainAspectRatio: false,
                        plugins: { 
                            legend: { display: false },
                            tooltip: { callbacks: { label: (context) => `Disponíveis: ${context.raw}` } }
                        },
                        scales: { 
                            y: { beginAtZero: true, ticks: { stepSize: 1 } }, 
                            x: { grid: { display: false } } 
                        }
                    }
                });

                // 3. Financeiro (VGV)
                const ctxFin = document.getElementById('financialChart').getContext('2d');
                charts.fin = new Chart(ctxFin, {
                    type: 'bar',
                    data: {
                        labels: ['Disp.', 'Vend.'],
                        datasets: [{
                            label: 'Valor (R$)',
                            data: [0, 0],
                            backgroundColor: ['#40916c', '#bc4749'],
                            borderRadius: 5
                        }]
                    },
                    options: {
                        responsive: true, 
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: { 
                            y: { 
                                beginAtZero: true, 
                                ticks: { 
                                    callback: v => 'R$ ' + (v/1000000).toFixed(1) + 'M' 
                                } 
                            } 
                        }
                    }
                });
            }

            // Sistema de Abas
            function initTabs() {
                const tabs = document.querySelectorAll('.tab');
                const tabContents = document.querySelectorAll('.tab-content');
                
                tabs.forEach(tab => {
                    tab.addEventListener('click', () => {
                        const tabId = tab.getAttribute('data-tab');
                        
                        // Ativar aba clicada
                        tabs.forEach(t => t.classList.remove('active'));
                        tab.classList.add('active');
                        
                        // Mostrar conteúdo correspondente
                        tabContents.forEach(content => {
                            content.classList.remove('active');
                            if (content.id === `${tabId}-tab`) {
                                content.classList.add('active');
                            }
                        });
                        
                        // Mostrar painel de clientes se for a aba de clientes
                        if (tabId === 'clientes') {
                            document.getElementById('clientesPanel').style.display = 'block';
                        }
                    });
                });
            }

            // Processamento PDF
            document.getElementById('importPdfButton').addEventListener('click', async () => {
                const file = document.getElementById('pdfFileInput').files[0];
                if (!file) return alert('Selecione o PDF.');
                
                document.getElementById('loadingIndicator').style.display = 'block';
                
                try {
                    const buffer = await file.arrayBuffer();
                    const pdf = await pdfjsLib.getDocument(buffer).promise;
                    let fullText = '';
                    
                    // Processar cada página para extrair texto
                    for (let i = 1; i <= pdf.numPages; i++) {
                        const page = await pdf.getPage(i);
                        const content = await page.getTextContent();
                        
                        // Extrair texto
                        fullText += content.items.map(item => item.str).join(' ') + '\n';
                    }
                    
                    // Processar dados extraídos
                    const parsedData = parseAndLoad(fullText);
                    const existingSoldItems = getExistingSoldItems();
                    const colorDetectedData = applyColorDetection(parsedData, existingSoldItems);
                    
                    database = colorDetectedData;
                    saveAndRender();
                    updateLoteSelect();
                    
                    alert(`${database.length} lotes carregados!`);
                } catch (e) {
                    alert('Erro ao ler PDF: ' + e.message);
                } finally {
                    document.getElementById('loadingIndicator').style.display = 'none';
                }
            });

            // Obter itens já marcados como vendidos no sistema
            function getExistingSoldItems() {
                return database.filter(item => item.status === 'vendido').map(item => item.item);
            }

            // Aplicar detecção de cores aos dados
            function applyColorDetection(parsedData, existingSoldItems) {
                // Primeiro, preservar o status dos lotes já marcados como vendidos
                const result = parsedData.map(item => {
                    // Se o item já estava marcado como vendido, manter esse status
                    if (existingSoldItems.includes(item.item)) {
                        item.status = 'vendido';
                    }
                    return item;
                });

                // Agora aplicar detecção baseada em texto para novos lotes
                return result.map(item => {
                    // Se o item não estava marcado como vendido anteriormente, aplicar detecção
                    if (item.status !== 'vendido') {
                        // Detectar por texto "VENDIDO" próximo ao item
                        const textAround = JSON.stringify(item).toUpperCase();
                        if (textAround.includes('VENDIDO') || textAround.includes('INDISPONIVEL') || 
                            textAround.includes('VEND') || textAround.includes('INDISP')) {
                            item.status = 'vendido';
                        }
                        
                        // Detectar por padrões específicos de formatação
                        // Muitos PDFs usam padrões como "R$ 0,00" ou valores zerados para lotes vendidos
                        if (item.total === '0,00' || item.total === '0' || 
                            item.sinal === '0,00' || item.sinal === '0') {
                            item.status = 'vendido';
                        }
                    }
                    
                    return item;
                });
            }

            function parseAndLoad(text) {
                const newData = [];
                // Limpar e normalizar o texto
                let cleanText = text.replace(/R\$\s*/gi, '').replace(/\t/g, ' ').replace(/\r/g, ' ').replace(/\n/g, ' ').replace(/\s+/g, ' ');

                // Regex para capturar todos os campos na ordem correta:
                // ITEM, QD, LT, Tam m2, Total, Sinal a vista, Reserva, saldo a vista, saldo em 2 x, saldo em 3 x, Saldo 60 meses, 120 meses ,156 meses, 160 meses
                const regex = /(\d+)\s+([A-Z])\s+(\d+)\s+([\d.,]+)\s+([\d.,]+)\s+([\d.,]+)\s+([\d.,]+)\s+([\d.,]+)\s+([\d.,]+)\s+([\d.,]+)\s+([\d.,]+)\s+([\d.,]+)\s+([\d.,]+)\s+([\d.,]+)\s+([\d.,]+)/g;
                let match;

                while ((match = regex.exec(cleanText)) !== null) {
                    // Status padrão é disponível - a detecção de cores vai ajustar depois
                    let status = 'disponivel';

                    newData.push({
                        item: match[1], 
                        qd: match[2], 
                        lt: match[3], 
                        tam: match[4], 
                        m2: match[5],
                        total: match[6] || '-', 
                        sinal: match[7] || '-', 
                        sinalVista: match[8] || '-',
                        reserva: match[9] || '-', 
                        saldoVista: match[10] || '-', 
                        saldo2x: match[11] || '-',
                        saldo3x: match[12] || '-', 
                        saldo60: match[13] || '-', 
                        p120: match[14] || '-',
                        p156: match[15] || '-', 
                        p160: match[16] || '-',
                        status: status
                    });
                }

                // Se a regex anterior não funcionar, tentar uma abordagem mais flexível
                if (newData.length === 0) {
                    console.log("Tentando abordagem alternativa...");
                    const altRegex = /(\d+)\s+([A-Z])\s+(\d+)\s+([\d.,]+)\s+([\d.,]+)/g;
                    let altMatch;
                    
                    while ((altMatch = altRegex.exec(cleanText)) !== null) {
                        const lookAhead = cleanText.substring(altRegex.lastIndex, altRegex.lastIndex + 1500);
                        const moneys = lookAhead.match(/([\d.,]+)/g) || [];
                        
                        let status = 'disponivel';

                        if (moneys.length >= 14) {
                            newData.push({
                                item: altMatch[1], 
                                qd: altMatch[2], 
                                lt: altMatch[3], 
                                tam: altMatch[4], 
                                m2: altMatch[5],
                                total: moneys[0] || '-', 
                                sinal: moneys[1] || '-', 
                                sinalVista: moneys[2] || '-',
                                reserva: moneys[3] || '-', 
                                saldoVista: moneys[4] || '-', 
                                saldo2x: moneys[5] || '-',
                                saldo3x: moneys[6] || '-', 
                                saldo60: moneys[7] || '-', 
                                p120: moneys[8] || '-',
                                p156: moneys[9] || '-', 
                                p160: moneys[10] || '-',
                                status: status
                            });
                        }
                    }
                }

                if (newData.length === 0) {
                    alert('Erro ao identificar tabela. Verifique se o PDF contém a tabela com os campos solicitados.');
                }
                
                return newData;
            }

            // Sistema de Backup
            document.getElementById('backupButton').addEventListener('click', () => {
                if (database.length === 0) {
                    alert('Não há dados para fazer backup.');
                    return;
                }
                
                const backupData = {
                    database: database,
                    clientes: clientes,
                    timestamp: new Date().toISOString(),
                    version: '6.0',
                    developer: 'Alex Peixoto - Todos os Direitos Reservados'
                };
                
                const dataStr = JSON.stringify(backupData, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `backup_reserva_foz_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                alert('Backup realizado com sucesso!');
            });

            document.getElementById('restoreButton').addEventListener('click', () => {
                document.getElementById('restoreFileInput').click();
            });

            document.getElementById('restoreFileInput').addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const backupData = JSON.parse(e.target.result);
                        
                        if (backupData.database && Array.isArray(backupData.database)) {
                            if (confirm(`Deseja restaurar backup com ${backupData.database.length} lotes?`)) {
                                database = backupData.database;
                                clientes = backupData.clientes || [];
                                saveAndRender();
                                renderClientes();
                                updateLoteSelect();
                                alert('Backup restaurado com sucesso!');
                            }
                        } else {
                            alert('Arquivo de backup inválido.');
                        }
                    } catch (error) {
                        alert('Erro ao ler arquivo de backup: ' + error.message);
                    }
                };
                reader.readAsText(file);
                event.target.value = ''; // Reset input
            });

            // Ação de mudar status (Manual + Bulk)
            window.toggleStatus = function(item) {
                const idx = database.findIndex(l => l.item === item);
                if (idx >= 0) {
                    database[idx].status = database[idx].status === 'vendido' ? 'disponivel' : 'vendido';
                    saveAndRender();
                    updateLoteSelect(); // Atualizar lista de lotes disponíveis
                    
                    // Verificar se algum cliente está relacionado a este lote
                    if (database[idx].status === 'vendido') {
                        const clientesComEsteLote = clientes.filter(c => c.loteId === item);
                        if (clientesComEsteLote.length > 0) {
                            alert(`Atenção: ${clientesComEsteLote.length} cliente(s) está(ão) relacionado(s) a este lote que foi marcado como vendido.`);
                        }
                    }
                }
            };

            document.getElementById('markSoldButton').addEventListener('click', () => {
                const ids = document.getElementById('soldItemsInput').value.split(/[\s,]+/).map(s => s.trim());
                let count = 0;
                database.forEach(l => {
                    if (ids.includes(l.item)) { 
                        l.status = 'vendido'; 
                        count++; 
                    }
                });
                if (count > 0) {
                    saveAndRender();
                    updateLoteSelect(); // Atualizar lista de lotes disponíveis
                    document.getElementById('soldItemsInput').value = '';
                    alert(`${count} marcados como VENDIDO.`);
                }
            });

            // Cadastro de Clientes
            document.getElementById('salvarCliente').addEventListener('click', () => {
                const nome = document.getElementById('clienteNome').value.trim();
                const telefone = document.getElementById('clienteTelefone').value.trim();
                const email = document.getElementById('clienteEmail').value.trim();
                const loteId = document.getElementById('clienteLote').value;
                const observacoes = document.getElementById('clienteObservacoes').value.trim();
                
                if (!nome) {
                    alert('Por favor, preencha o nome do cliente.');
                    return;
                }
                
                if (!loteId) {
                    alert('Por favor, selecione um lote de interesse.');
                    return;
                }
                
                const lote = database.find(l => l.item === loteId);
                if (!lote) {
                    alert('Lote selecionado não encontrado.');
                    return;
                }
                
                // VALIDAÇÃO: Verificar se o lote está disponível
                if (lote.status !== 'disponivel') {
                    alert('Erro: O lote selecionado não está disponível para venda. Por favor, selecione um lote disponível.');
                    return;
                }
                
                if (editingClienteId) {
                    // Editar cliente existente
                    const clienteIndex = clientes.findIndex(c => c.id === editingClienteId);
                    if (clienteIndex !== -1) {
                        clientes[clienteIndex] = {
                            ...clientes[clienteIndex],
                            nome: nome,
                            telefone: telefone,
                            email: email,
                            loteId: loteId,
                            loteInfo: `${lote.qd} / ${lote.lt}`,
                            observacoes: observacoes
                        };
                    }
                    editingClienteId = null;
                } else {
                    // Criar novo cliente
                    const novoCliente = {
                        id: Date.now().toString(),
                        nome: nome,
                        telefone: telefone,
                        email: email,
                        loteId: loteId,
                        loteInfo: `${lote.qd} / ${lote.lt}`,
                        observacoes: observacoes,
                        dataCadastro: new Date().toISOString()
                    };
                    
                    clientes.push(novoCliente);
                }
                
                saveClientes();
                renderClientes();
                closeClienteModal();
                
                alert(editingClienteId ? 'Cliente atualizado com sucesso!' : 'Cliente cadastrado com sucesso!');
            });

            // Atualizar select de lotes - MOSTRAR APENAS LOTES DISPONÍVEIS
            function updateLoteSelect() {
                const select = document.getElementById('clienteLote');
                const filterSelect = document.getElementById('filterClienteLote');
                
                select.innerHTML = '<option value="">Selecione um lote disponível</option>';
                filterSelect.innerHTML = '<option value="todos">Todos os lotes</option>';
                
                // Filtrar apenas lotes disponíveis
                const lotesDisponiveis = database.filter(l => l.status === 'disponivel');
                
                if (lotesDisponiveis.length === 0) {
                    const option = document.createElement('option');
                    option.value = "";
                    option.textContent = "Nenhum lote disponível";
                    option.disabled = true;
                    select.appendChild(option);
                } else {
                    lotesDisponiveis.forEach(lote => {
                        const option = document.createElement('option');
                        option.value = lote.item;
                        option.textContent = `Qd ${lote.qd} - Lt ${lote.lt} (${lote.tam}m² - ${lote.total})`;
                        option.setAttribute('data-lote-info', JSON.stringify(lote));
                        select.appendChild(option);
                        
                        const filterOption = document.createElement('option');
                        filterOption.value = lote.item;
                        filterOption.textContent = `Qd ${lote.qd} - Lt ${lote.lt}`;
                        filterSelect.appendChild(filterOption);
                    });
                }
                
                // Adicionar evento para mostrar detalhes do lote selecionado
                select.addEventListener('change', function() {
                    const selectedOption = this.options[this.selectedIndex];
                    const loteInfoDiv = document.getElementById('loteInfo');
                    const loteDetailsSpan = document.getElementById('loteDetails');
                    
                    if (this.value && selectedOption.getAttribute('data-lote-info')) {
                        const lote = JSON.parse(selectedOption.getAttribute('data-lote-info'));
                        loteDetailsSpan.innerHTML = `
                            <strong>Detalhes do Lote:</strong> ${lote.tam}m² | Valor m²: ${lote.m2} | Total: ${lote.total}
                        `;
                        loteInfoDiv.style.display = 'block';
                    } else {
                        loteInfoDiv.style.display = 'none';
                    }
                });
            }

            // Renderizar clientes
            function renderClientes() {
                const container = document.getElementById('clientesContainer');
                const searchTerm = document.getElementById('searchCliente').value.toLowerCase();
                const filterLote = document.getElementById('filterClienteLote').value;
                
                let filteredClientes = clientes;
                
                // Aplicar filtros
                if (searchTerm) {
                    filteredClientes = filteredClientes.filter(cliente => 
                        cliente.nome.toLowerCase().includes(searchTerm) ||
                        cliente.telefone.includes(searchTerm) ||
                        cliente.email.toLowerCase().includes(searchTerm)
                    );
                }
                
                if (filterLote && filterLote !== 'todos') {
                    filteredClientes = filteredClientes.filter(cliente => cliente.loteId === filterLote);
                }
                
                container.innerHTML = '';
                
                if (filteredClientes.length === 0) {
                    container.innerHTML = `
                        <div style="grid-column:1/-1; text-align:center; padding:20px; color:#aaa;">
                            <i class="fas fa-user-plus" style="font-size:2rem; margin-bottom:8px;"></i>
                            <p>Nenhum cliente encontrado.</p>
                        </div>
                    `;
                    return;
                }
                
                filteredClientes.forEach(cliente => {
                    const div = document.createElement('div');
                    div.className = 'cliente-card';
                    
                    // Verificar se o lote ainda está disponível
                    const lote = database.find(l => l.item === cliente.loteId);
                    const loteDisponivel = lote && lote.status === 'disponivel';
                    
                    div.innerHTML = `
                        <div class="cliente-header">
                            <div class="cliente-nome">${cliente.nome}</div>
                            ${!loteDisponivel ? '<span style="color: var(--danger-color); font-size: 0.7rem;"><i class="fas fa-exclamation-triangle"></i> Lote Vendido</span>' : ''}
                        </div>
                        <div class="cliente-contato">
                            <div><i class="fas fa-phone"></i> ${cliente.telefone || 'Não informado'}</div>
                            <div><i class="fas fa-envelope"></i> ${cliente.email || 'Não informado'}</div>
                        </div>
                        <div class="cliente-lote" style="${!loteDisponivel ? 'background: #ffebee; color: #c62828;' : ''}">
                            <i class="fas fa-home"></i> Lote: ${cliente.loteInfo}
                            ${lote ? ` (${lote.tam}m² - ${lote.total})` : ''}
                        </div>
                        ${cliente.observacoes ? `
                            <div class="cliente-obs">
                                <strong>Observações:</strong> ${cliente.observacoes}
                            </div>
                        ` : ''}
                        <div class="cliente-actions">
                            <button class="btn-sm btn-primary" onclick="gerarFichaCliente('${cliente.id}')">
                                <i class="fas fa-download"></i> Ficha PDF
                            </button>
                            <button class="btn-sm btn-outline" onclick="editarCliente('${cliente.id}')" ${!loteDisponivel ? 'disabled style="opacity: 0.5;"' : ''}>
                                <i class="fas fa-edit"></i> Editar
                            </button>
                            <button class="btn-sm btn-danger" onclick="excluirCliente('${cliente.id}')">
                                <i class="fas fa-trash"></i> Excluir
                            </button>
                        </div>
                    `;
                    
                    container.appendChild(div);
                });
            }

            // Funções globais para ações de clientes
            window.gerarFichaCliente = function(clienteId) {
                const cliente = clientes.find(c => c.id === clienteId);
                if (!cliente) return;
                
                const lote = database.find(l => l.item === cliente.loteId);
                if (!lote) {
                    alert('Lote relacionado não encontrado.');
                    return;
                }
                
                currentCliente = cliente;
                prepareFichaCliente(cliente, lote);
                downloadFichaCliente();
            };

            window.editarCliente = function(clienteId) {
                const cliente = clientes.find(c => c.id === clienteId);
                if (!cliente) return;
                
                // Verificar se o lote ainda está disponível
                const lote = database.find(l => l.item === cliente.loteId);
                if (lote && lote.status !== 'disponivel') {
                    if (!confirm('Atenção: O lote relacionado a este cliente não está mais disponível. Deseja continuar com a edição?')) {
                        return;
                    }
                }
                
                document.getElementById('clienteNome').value = cliente.nome;
                document.getElementById('clienteTelefone').value = cliente.telefone;
                document.getElementById('clienteEmail').value = cliente.email;
                document.getElementById('clienteLote').value = cliente.loteId;
                document.getElementById('clienteObservacoes').value = cliente.observacoes;
                
                editingClienteId = clienteId;
                document.getElementById('clienteModalTitle').textContent = 'Editar Cliente';
                openClienteModal();
            };

            window.excluirCliente = function(clienteId) {
                if (confirm('Tem certeza que deseja excluir este cliente?')) {
                    clientes = clientes.filter(c => c.id !== clienteId);
                    saveClientes();
                    renderClientes();
                    alert('Cliente excluído com sucesso.');
                }
            };

            // Abrir modal de cliente
            window.openClienteModal = function() {
                document.getElementById('clienteModal').style.display = 'flex';
                updateLoteSelect(); // Atualizar lista sempre que abrir o modal
            };

            // Fechar modal de cliente
            window.closeClienteModal = function() {
                document.getElementById('clienteModal').style.display = 'none';
                document.getElementById('clienteModalTitle').textContent = 'Cadastrar Novo Cliente';
                document.getElementById('clienteNome').value = '';
                document.getElementById('clienteTelefone').value = '';
                document.getElementById('clienteEmail').value = '';
                document.getElementById('clienteLote').value = '';
                document.getElementById('clienteObservacoes').value = '';
                document.getElementById('loteInfo').style.display = 'none';
                editingClienteId = null;
            };

            // Preparar ficha do cliente para impressão/PDF
            function prepareFichaCliente(cliente, lote) {
                document.getElementById('fichaClienteNome').textContent = cliente.nome;
                document.getElementById('fichaClienteTelefone').textContent = cliente.telefone || 'Não informado';
                document.getElementById('fichaClienteEmail').textContent = cliente.email || 'Não informado';
                document.getElementById('fichaClienteData').textContent = new Date(cliente.dataCadastro).toLocaleDateString('pt-BR');
                document.getElementById('fichaClienteLote').textContent = cliente.loteInfo;
                document.getElementById('fichaClienteArea').textContent = lote.tam;
                document.getElementById('fichaClienteValor').textContent = lote.total;
                document.getElementById('fichaClienteObservacoes').textContent = cliente.observacoes || 'Nenhuma observação registrada.';
                document.getElementById('fichaClienteGeradoEm').textContent = new Date().toLocaleDateString('pt-BR');
            }

            // Baixar ficha do cliente como PDF
            async function downloadFichaCliente() {
                if (!currentCliente) {
                    alert('Nenhum cliente selecionado.');
                    return;
                }
                
                try {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF('p', 'mm', 'a4');
                    
                    // Capturar a ficha do cliente como imagem
                    const fichaElement = document.getElementById('printFichaCliente');
                    
                    // Mostrar temporariamente a ficha para captura
                    fichaElement.style.display = 'block';
                    
                    const canvas = await html2canvas(fichaElement, {
                        scale: 2,
                        useCORS: true,
                        logging: false,
                        backgroundColor: '#ffffff'
                    });
                    
                    // Ocultar a ficha novamente
                    fichaElement.style.display = 'none';
                    
                    const imgData = canvas.toDataURL('image/png');
                    const imgWidth = 190; // Largura menor para margens
                    const imgHeight = canvas.height * imgWidth / canvas.width;
                    
                    // Calcular posição para centralizar
                    const xPosition = (210 - imgWidth) / 2; // 210mm é a largura do A4
                    
                    doc.addImage(imgData, 'PNG', xPosition, 10, imgWidth, imgHeight);
                    
                    doc.save(`Ficha_Cliente_${currentCliente.nome.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.pdf`);
                    
                } catch (error) {
                    console.error('Erro ao gerar PDF:', error);
                    alert('Erro ao gerar PDF. Verifique o console para mais detalhes.');
                }
            }

            // Salvar clientes no localStorage
            function saveClientes() {
                localStorage.setItem('reservaFoz_clientes', JSON.stringify(clientes));
            }

            // Carregar clientes do localStorage
            function loadClientes() {
                const saved = localStorage.getItem('reservaFoz_clientes');
                if (saved) {
                    clientes = JSON.parse(saved);
                    renderClientes();
                }
            }

            // Renderização
            function saveAndRender() {
                localStorage.setItem('reservaFoz_db4', JSON.stringify(database));
                updateStats();
                filterLotes();
                updateLoteSelect();
            }

            function updateStats() {
                const total = database.length;
                const sold = database.filter(l => l.status === 'vendido');
                const avail = database.filter(l => l.status !== 'vendido');

                // Texto
                document.getElementById('totalCount').innerText = total;
                document.getElementById('availCount').innerText = avail.length;
                document.getElementById('soldCount').innerText = sold.length;

                // 1. Chart Quantidade
                charts.qty.data.datasets[0].data = [avail.length, sold.length];
                charts.qty.update();

                // 2. Chart Quadras (Disponíveis)
                const quadraCounts = {};
                avail.forEach(l => {
                    quadraCounts[l.qd] = (quadraCounts[l.qd] || 0) + 1;
                });
                
                const sortedQuadras = Object.keys(quadraCounts).sort();
                charts.quadra.data.labels = sortedQuadras;
                charts.quadra.data.datasets[0].data = sortedQuadras.map(q => quadraCounts[q]);
                charts.quadra.update();

                // 3. Chart Financeiro
                const sumVal = (arr) => arr.reduce((acc, l) => {
                    let v = parseFloat(l.total.replace(/\./g,'').replace(',','.'));
                    return acc + (isNaN(v) ? 0 : v);
                }, 0);
                charts.fin.data.datasets[0].data = [sumVal(avail), sumVal(sold)];
                charts.fin.update();
                
                // 4. Valor Médio Geral
                const allValues = database.map(l => {
                    return parseFloat(l.total.replace(/\./g,'').replace(',','.')) || 0;
                });
                const avgValue = allValues.reduce((acc, val) => acc + val, 0) / allValues.length;
                
                if (!isNaN(avgValue)) {
                    document.getElementById('avgTotalValue').textContent = 
                        'R$ ' + avgValue.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                } else {
                    document.getElementById('avgTotalValue').textContent = 'R$ 0,00';
                }
            }

            function filterLotes() {
                const sLote = document.getElementById('searchLote').value.toLowerCase();
                const sQuadra = document.getElementById('searchQuadra').value.toUpperCase();
                const status = document.getElementById('filterStatus').value;
                const sort = document.getElementById('sortSelect').value;

                let res = database.filter(l => {
                    const match = l.lt.includes(sLote) && (l.qd.includes(sQuadra) || sQuadra === '');
                    if (status === 'todos') return match;
                    return match && l.status === status;
                });

                res.sort((a,b) => {
                    if (sort === 'quadra') return a.qd.localeCompare(b.qd) || parseInt(a.lt) - parseInt(b.lt);
                    if (sort === 'valor') {
                        const vA = parseFloat(a.total.replace(/\./g,'').replace(',','.')) || 0;
                        const vB = parseFloat(b.total.replace(/\./g,'').replace(',','.')) || 0;
                        return vA - vB;
                    }
                });

                const container = document.getElementById('resultsContainer');
                container.innerHTML = '';
                
                if (res.length === 0) container.innerHTML = '<p style="grid-column:1/-1; text-align:center; font-size:0.9rem;">Nenhum lote encontrado.</p>';

                res.forEach(l => {
                    const isSold = l.status === 'vendido';
                    const div = document.createElement('div');
                    div.className = `lot-card ${l.status}`;
                    
                    // O onclick no DIV abre o modal
                    div.onclick = () => openModal(l);

                    div.innerHTML = `
                        <div class="lot-card-header">
                            <strong>Qd ${l.qd} - Lt ${l.lt}</strong>
                            <div style="text-align:right">
                                <span class="status-badge" style="color:#333">${isSold ? 'VENDIDO' : 'DISPONÍVEL'}</span>
                            </div>
                        </div>
                        <div class="lot-body">
                            <div class="lot-info-row"><span>Área:</span> <b>${l.tam} m²</b></div>
                            <div class="lot-info-row"><span>Total:</span> <b>${l.total}</b></div>
                            <div class="lot-info-row"><span>Sinal:</span> <b>${l.sinal}</b></div>
                        </div>
                        <button class="btn-action-card" 
                            onclick="event.stopPropagation(); toggleStatus('${l.item}')" 
                            title="Mudar Status Rápido">
                            ${isSold ? '<i class="fas fa-undo"></i> Disponível' : '<i class="fas fa-check"></i> Vendido'}
                        </button>
                    `;
                    container.appendChild(div);
                });
            }

            // Modal Logic
            window.openModal = function(lote) {
                currentLote = lote;
                document.getElementById('modalTitle').innerText = `Detalhes: Quadra ${lote.qd} - Lote ${lote.lt}`;
                const fields = [
                    'mQuadraLote', 'mItem', 'mTam', 'mM2', 'mTotal', 
                    'mSinal', 'mSinalVista', 'mReserva', 'mSaldoVista', 
                    'mSaldo2x', 'mSaldo3x', 'mSaldo60', 'm120', 'm156', 'm160'
                ];
                const values = [
                    `${lote.qd} / ${lote.lt}`, lote.item, lote.tam, lote.m2, lote.total,
                    lote.sinal, lote.sinalVista, lote.reserva, lote.saldoVista,
                    lote.saldo2x, lote.saldo3x, lote.saldo60, lote.p120, lote.p156, lote.p160
                ];
                fields.forEach((id, i) => document.getElementById(id).innerText = values[i] || '-');
                document.getElementById('detailModal').style.display = 'flex';
                
                // Preparar ficha para impressão
                prepareFicha(lote);
            };

            // Preparar ficha para impressão/PDF
            function prepareFicha(lote) {
                const isSold = lote.status === 'vendido';
                
                // Preencher dados da ficha
                document.getElementById('fichaQuadraLote').textContent = `${lote.qd} / ${lote.lt}`;
                document.getElementById('fichaItem').textContent = lote.item;
                document.getElementById('fichaArea').textContent = lote.tam;
                document.getElementById('fichaM2').textContent = lote.m2;
                document.getElementById('fichaStatus').textContent = isSold ? 'VENDIDO' : 'DISPONÍVEL';
                document.getElementById('fichaData').textContent = new Date().toLocaleDateString('pt-BR');
                document.getElementById('fichaValorTotal').textContent = lote.total;
                document.getElementById('fichaSinal').textContent = lote.sinal;
                document.getElementById('fichaSinalVista').textContent = lote.sinalVista;
                document.getElementById('fichaReserva').textContent = lote.reserva;
                document.getElementById('fichaSaldoVista').textContent = lote.saldoVista;
                document.getElementById('fichaSaldo2x').textContent = lote.saldo2x;
                document.getElementById('fichaSaldo3x').textContent = lote.saldo3x;
                document.getElementById('fichaSaldo60').textContent = lote.saldo60;
                document.getElementById('ficha120').textContent = lote.p120;
                document.getElementById('ficha156').textContent = lote.p156;
                document.getElementById('ficha160').textContent = lote.p160;
                document.getElementById('fichaGeradoEm').textContent = new Date().toLocaleDateString('pt-BR');
                
                // Atualizar badge de status
                const statusBadge = document.getElementById('fichaStatusBadge');
                statusBadge.className = `ficha-status ${isSold ? 'status-vendido' : 'status-disponivel'}`;
                statusBadge.textContent = isSold ? 'VENDIDO' : 'DISPONÍVEL';
            }

            // Baixar ficha como PDF (CORRIGIDO)
            document.getElementById('downloadFichaButton').addEventListener('click', async () => {
                if (!currentLote) {
                    alert('Nenhum lote selecionado.');
                    return;
                }
                
                try {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF('p', 'mm', 'a4');
                    
                    // Preparar a ficha antes de capturar
                    prepareFicha(currentLote);
                    
                    // Capturar a ficha como imagem
                    const fichaElement = document.getElementById('printFicha');
                    
                    // Mostrar temporariamente a ficha para captura
                    fichaElement.style.display = 'block';
                    
                    const canvas = await html2canvas(fichaElement, {
                        scale: 2,
                        useCORS: true,
                        logging: false,
                        backgroundColor: '#ffffff'
                    });
                    
                    // Ocultar a ficha novamente
                    fichaElement.style.display = 'none';
                    
                    const imgData = canvas.toDataURL('image/png');
                    const imgWidth = 190; // Largura menor para margens
                    const imgHeight = canvas.height * imgWidth / canvas.width;
                    
                    // Calcular posição para centralizar
                    const xPosition = (210 - imgWidth) / 2; // 210mm é a largura do A4
                    
                    doc.addImage(imgData, 'PNG', xPosition, 10, imgWidth, imgHeight);
                    
                    doc.save(`Ficha_Lote_${currentLote.qd}_${currentLote.lt}_${new Date().toISOString().split('T')[0]}.pdf`);
                    
                } catch (error) {
                    console.error('Erro ao gerar PDF:', error);
                    alert('Erro ao gerar PDF. Verifique o console para mais detalhes.');
                }
            });

            window.closeModal = function() { 
                document.getElementById('detailModal').style.display = 'none'; 
                currentLote = null;
            };

            // Listeners
            ['searchLote', 'searchQuadra', 'filterStatus', 'sortSelect'].forEach(id => {
                document.getElementById(id).addEventListener('input', filterLotes);
            });

            // Listeners para busca de clientes
            document.getElementById('searchCliente').addEventListener('input', renderClientes);
            document.getElementById('filterClienteLote').addEventListener('change', renderClientes);
            
            document.getElementById('clearButton').addEventListener('click', () => {
                if(confirm('Limpar tudo?')) { 
                    localStorage.removeItem('reservaFoz_db4'); 
                    localStorage.removeItem('reservaFoz_clientes');
                    database = []; 
                    clientes = [];
                    saveAndRender();
                    renderClientes();
                }
            });

            // Botões para abrir modal de cliente
            document.getElementById('novoClienteBtn').addEventListener('click', openClienteModal);
            document.getElementById('novoClienteEmptyBtn').addEventListener('click', openClienteModal);

            // Exportação PDF otimizada com melhor aproveitamento de espaço
            document.getElementById('downloadFullPdf').addEventListener('click', () => {
                if (database.length === 0) return alert('Sem dados para exportar.');
                
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('l', 'mm', 'a4'); 
                
                // Configurações otimizadas para melhor aproveitamento
                doc.setFontSize(16);
                doc.setTextColor(27, 77, 62);
                doc.text("Tabela de Disponibilidade - RESERVA DA FOZ", 15, 12);
                doc.setFontSize(10);
                doc.text(`Gerado em: ${new Date().toLocaleDateString()}`, 15, 18);

                // Preparar dados - apenas lotes disponíveis
                const list = database
                    .filter(l => l.status !== 'vendido')
                    .sort((a,b) => a.qd.localeCompare(b.qd) || parseInt(a.lt) - parseInt(b.lt));

                // Criar corpo da tabela com todas as colunas
                const body = list.map(l => [
                    l.item, 
                    l.qd, 
                    l.lt, 
                    l.tam, 
                    l.total, 
                    l.sinal, 
                    l.sinalVista,
                    l.reserva, 
                    l.saldoVista, 
                    l.saldo2x,
                    l.saldo3x,
                    l.saldo60,
                    l.p120,
                    l.p156,
                    l.p160
                ]);

                // Configurar a tabela com melhor aproveitamento de espaço
                doc.autoTable({
                    head: [
                        ['Item', 'Qd', 'Lt', 'M²', 'Total', 'Sinal', 'Sinal Vista', 'Reserva', 
                         'Saldo Vista', 'Saldo 2x', 'Saldo 3x', 'Saldo 60', '120x', '156x', '160x']
                    ],
                    body: body,
                    startY: 22,
                    styles: { 
                        fontSize: 7, // Fonte um pouco maior para melhor legibilidade
                        cellPadding: 2,
                        lineColor: [200, 200, 200],
                        lineWidth: 0.1,
                        font: 'helvetica'
                    },
                    headStyles: { 
                        fillColor: [27, 77, 62],
                        textColor: [255, 255, 255],
                        fontSize: 7,
                        fontStyle: 'bold',
                        cellPadding: 3
                    },
                    alternateRowStyles: { 
                        fillColor: [241, 248, 244] 
                    },
                    margin: { left: 8, right: 8, top: 22 }, // Margens otimizadas
                    tableWidth: 'wrap',
                    columnStyles: {
                        0: { cellWidth: 14 }, // Item
                        1: { cellWidth: 12 }, // Qd
                        2: { cellWidth: 12 }, // Lt
                        3: { cellWidth: 16 }, // M²
                        4: { cellWidth: 22 }, // Total
                        5: { cellWidth: 18 }, // Sinal
                        6: { cellWidth: 20 }, // Sinal Vista
                        7: { cellWidth: 18 }, // Reserva
                        8: { cellWidth: 20 }, // Saldo Vista
                        9: { cellWidth: 18 }, // Saldo 2x
                        10: { cellWidth: 18 }, // Saldo 3x
                        11: { cellWidth: 18 }, // Saldo 60
                        12: { cellWidth: 16 }, // 120x
                        13: { cellWidth: 16 }, // 156x
                        14: { cellWidth: 16 }  // 160x
                    },
                    // Ajustes para melhor quebra de texto
                    didDrawPage: function (data) {
                        // Adicionar número da página
                        doc.setFontSize(8);
                        doc.setTextColor(100);
                        doc.text(
                            `Página ${data.pageNumber}`,
                            data.settings.margin.left,
                            doc.internal.pageSize.height - 10
                        );
                    }
                });

                doc.save(`Tabela_Disponiveis_${new Date().toISOString().split('T')[0]}.pdf`);
            });

            // Init
            initSimplifiedMode();
            initCharts();
            initTabs();
            const saved = localStorage.getItem('reservaFoz_db4');
            if (saved) { database = JSON.parse(saved); saveAndRender(); }
            loadClientes();
        });
    </script>
</body>
</html>
