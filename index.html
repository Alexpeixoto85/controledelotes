<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reserva da Foz - Sistema Integrado Completo</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        :root {
            /* Paleta Amazônia */
            --primary-color: #1b4d3e;      /* Verde Floresta */
            --primary-light: #2d6a4f;
            --secondary-color: #8c6239;    /* Terra */
            --bg-color: #f1f8f4;           /* Menta Suave */
            --card-bg: #ffffff;
            
            /* Status */
            --success-color: #40916c;
            --danger-color: #bc4749;
            
            --text-dark: #1f2421;
            --border-radius: 12px;
            --box-shadow: 0 6px 15px rgba(27, 77, 62, 0.15);
            --transition: all 0.3s ease;
        }
        
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            font-family: 'Segoe UI', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-dark);
            padding: 20px;
            background-image: radial-gradient(#1b4d3e 0.5px, transparent 0.5px);
            background-size: 20px 20px;
        }
        
        .container { max-width: 1400px; margin: 0 auto; }
        
        /* Header */
        header {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-light));
            padding: 25px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            margin-bottom: 20px;
            text-align: center;
            color: white;
        }
        
        /* Layout Grid */
        .main-grid {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 20px;
            transition: var(--transition);
        }
        
        .main-grid.simplified {
            grid-template-columns: 1fr;
        }

        .card {
            background-color: var(--card-bg);
            padding: 18px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            margin-bottom: 20px;
            border-left: 5px solid var(--primary-color);
            transition: var(--transition);
        }
        
        .card.hidden { display: none; }
        
        .card h2 {
            color: var(--primary-color);
            margin-bottom: 12px;
            font-size: 1.1rem;
            font-weight: 700;
            border-bottom: 2px solid #eee;
            padding-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Botões */
        button {
            padding: 8px;
            font-size: 12px;
            font-weight: 600;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            width: 100%;
        }
        .btn-primary { background-color: var(--primary-color); color: white; }
        .btn-primary:hover { background-color: var(--primary-light); transform: translateY(-2px); }
        .btn-success { background-color: var(--success-color); color: white; }
        .btn-danger { background-color: var(--danger-color); color: white; }
        .btn-outline { border: 2px solid var(--primary-color); color: var(--primary-color); background: transparent; }
        .btn-outline:hover { background: var(--primary-color); color: white; }
        .btn-warning { background-color: #e9b949; color: white; }
        
        .btn-sm { padding: 4px 8px; font-size: 0.75rem; width: auto; margin: 0; }
        .btn-action-card { 
            border: 1px solid #ccc; color: #555; background: #f8f9fa; 
            position: absolute; bottom: 12px; right: 12px; z-index: 5;
        }
        .btn-action-card:hover { background: #e2e6ea; color: #000; }

        /* Inputs */
        .file-input-wrapper { position: relative; margin-bottom: 12px; }
        input[type="file"] {
            width: 100%; padding: 8px; border: 2px dashed var(--primary-light);
            border-radius: var(--border-radius); background: #f9fbf9; cursor: pointer;
            font-size: 0.85rem;
        }
        .search-bar { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 15px; }
        .search-input { flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 0.85rem; }
        
        /* Formulários */
        .form-group { margin-bottom: 12px; }
        .form-label { display: block; font-size: 0.8rem; margin-bottom: 4px; color: #555; font-weight: 600; }
        .form-control { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 0.85rem; }
        textarea.form-control { min-height: 80px; resize: vertical; }

        /* Gráficos e Cards */
        .chart-wrapper { position: relative; height: 170px; margin-bottom: 15px; }
        #resultsContainer { display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 15px; }
        
        .lot-card {
            background: white; border-radius: var(--border-radius);
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); transition: var(--transition);
            border: 1px solid #eee; cursor: pointer; position: relative;
            display: flex; flex-direction: column; padding-bottom: 45px;
        }
        .lot-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
        .lot-card-header { padding: 12px; color: white; display: flex; justify-content: space-between; border-radius: 10px 10px 0 0; }
        .lot-card.disponivel .lot-card-header { background: var(--success-color); }
        .lot-card.vendido .lot-card-header { background: var(--danger-color); }
        .lot-card.vendido { opacity: 0.85; }
        
        .lot-body { padding: 12px; font-size: 0.8rem; flex-grow: 1; }
        .lot-info-row { display: flex; justify-content: space-between; margin-bottom: 5px; border-bottom: 1px dashed #eee; padding-bottom: 3px; }
        
        /* MODAL */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); z-index: 1000; align-items: center; justify-content: center;
            backdrop-filter: blur(3px);
        }
        .modal-content {
            background: white; width: 95%; max-width: 800px; max-height: 90vh;
            border-radius: 12px; overflow-y: auto; position: relative;
            box-shadow: 0 20px 50px rgba(0,0,0,0.3); animation: slideUp 0.3s ease;
        }
        @keyframes slideUp { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .modal-header { background: var(--primary-color); color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; }
        .modal-body { padding: 18px; }
        .close-modal { background: none; border: none; color: white; font-size: 1.3rem; cursor: pointer; width: auto; margin: 0; }
        
        .detail-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(170px, 1fr)); gap: 10px; }
        .detail-item { background: #f8f9fa; padding: 8px; border-radius: 6px; }
        .detail-label { font-size: 0.7rem; color: #666; display: block; }
        .detail-value { font-size: 0.85rem; font-weight: bold; color: var(--primary-color); display: block; }

        /* Layouts Especiais */
        .status-badge { background: rgba(255,255,255,0.9); color: #333; padding: 3px 7px; border-radius: 10px; font-size: 0.65rem; font-weight: bold; }
        .sales-input-area { background-color: #ffedea; border: 1px solid #ffcccb; padding: 12px; border-radius: 10px; margin-top: 15px; }
        
        .avg-value-card {
            background: linear-gradient(135deg, #8c6239, #a87c52); color: white; text-align: center;
            padding: 15px; border-radius: var(--border-radius); margin-bottom: 18px; box-shadow: var(--box-shadow);
        }
        
        .mode-toggle-card {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef); border: 1px solid #dee2e6;
            padding: 12px 15px; border-radius: var(--border-radius); margin-bottom: 18px;
            display: flex; justify-content: space-between; align-items: center;
        }
        
        /* Toggle Switch */
        .toggle-switch { position: relative; display: inline-block; width: 50px; height: 24px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .toggle-slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 24px; }
        .toggle-slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .toggle-slider { background-color: var(--primary-color); }
        input:checked + .toggle-slider:before { transform: translateX(26px); }

        /* FICHAS DE IMPRESSÃO (Escondidas) */
        .print-ficha {
            display: none; /* Só aparece ao gerar imagem */
            background: white;
            width: 800px; /* Largura fixa para canvas */
            padding: 30px;
            border-radius: 0;
            font-family: 'Arial', sans-serif;
        }

        .ficha-print-header {
            background: #1b4d3e; color: white; padding: 20px; text-align: center;
            border-radius: 8px 8px 0 0; margin-bottom: 20px;
        }
        .ficha-print-title { font-size: 24px; margin-bottom: 5px; font-weight: bold; }
        .ficha-print-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .ficha-print-item { background: #f5f5f5; padding: 10px; border-left: 4px solid #1b4d3e; }
        .ficha-print-label { font-size: 10px; color: #666; display: block; text-transform: uppercase; }
        .ficha-print-value { font-size: 14px; font-weight: bold; color: #333; display: block; }
        .ficha-print-highlight { background: #e8f5e9; padding: 15px; text-align: center; border: 1px solid #1b4d3e; margin: 20px 0; }
        .ficha-print-footer { text-align: center; font-size: 10px; color: #999; margin-top: 30px; border-top: 1px solid #eee; padding-top: 10px; }

        /* Clientes e Imobiliarias Grid */
        .clientes-grid, .imobiliarias-grid, .relatorios-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px; margin-top: 15px; }
        
        .cliente-card, .imobiliaria-card, .relatorio-card {
            background: white; border-radius: var(--border-radius); padding: 15px;
            border-left: 4px solid var(--primary-color); box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .imobiliaria-card { border-left-color: var(--secondary-color); }

        /* Tabs */
        .tabs { display: flex; border-bottom: 1px solid #ddd; margin-bottom: 15px; gap: 5px; }
        .tab { padding: 10px 20px; cursor: pointer; border-bottom: 3px solid transparent; font-weight: 600; opacity: 0.6; }
        .tab:hover { opacity: 0.8; background: rgba(0,0,0,0.02); }
        .tab.active { border-bottom-color: var(--primary-color); color: var(--primary-color); opacity: 1; }
        .tab-content { display: none; animation: fadeIn 0.3s; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Ranking */
        .ranking-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px dashed #eee; }
        .ranking-position { background: var(--secondary-color); color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 0.8rem; }

        @media (max-width: 900px) { 
            .main-grid { grid-template-columns: 1fr; } 
            .ficha-print-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

    <div class="container">
        <header>
            <h1><i class="fas fa-tree"></i> Reserva da Foz</h1>
            <p>Sistema de Gestão de Estoque e Parcerias</p>
        </header>

        <div class="mode-toggle-card">
            <div class="toggle-label" style="font-weight:600; color:var(--primary-color);">
                <i class="fas fa-eye-slash"></i> Modo Simplificado (Ocultar Painéis Laterais)
            </div>
            <label class="toggle-switch">
                <input type="checkbox" id="simplifiedModeToggle">
                <span class="toggle-slider"></span>
            </label>
        </div>

        <div class="tabs">
            <div class="tab active" data-tab="lotes">Lotes e Mapa</div>
            <div class="tab" data-tab="clientes">Gestão de Clientes</div>
            <div class="tab" data-tab="imobiliarias">Imobiliárias</div>
            <div class="tab" data-tab="relatorios">Relatórios Gerenciais</div>
        </div>

        <div class="tab-content active" id="lotes-tab">
            <div class="main-grid" id="mainGrid">
                <div class="controls-column" id="controlsColumn">
                    <div class="card config-card">
                        <h2><i class="fas fa-file-import"></i> Importar Tabela</h2>
                        <div class="file-input-wrapper">
                            <input type="file" id="pdfFileInput" accept=".pdf">
                        </div>
                        <button id="importPdfButton" class="btn-primary"><i class="fas fa-cog"></i> Processar PDF</button>
                        <div id="loadingIndicator" style="display:none; text-align:center; margin-top:8px; color:#666; font-size:0.8rem;">Processando arquivo...</div>
                    </div>

                    <div class="avg-value-card">
                        <h3><i class="fas fa-chart-line"></i> Ticket Médio</h3>
                        <div class="value" id="avgTotalValue">R$ 0,00</div>
                        <div class="description">Valor médio por lote</div>
                    </div>

                    <div class="card">
                        <h2><i class="fas fa-chart-pie"></i> Status Geral</h2>
                        <div class="chart-wrapper" style="height: 150px;">
                            <canvas id="quantityChart"></canvas>
                        </div>
                        <div style="display:flex; justify-content:space-between; font-size:0.8rem; margin-top:10px; padding-top:8px; border-top:1px dashed #eee;">
                            <span>Total: <strong id="totalCount">0</strong></span>
                            <span style="color:var(--success-color)">Disp: <strong id="availCount">0</strong></span>
                            <span style="color:var(--danger-color)">Vend: <strong id="soldCount">0</strong></span>
                        </div>
                    </div>

                    <div class="card">
                        <h2><i class="fas fa-building"></i> Mapa de Quadras</h2>
                        <div class="chart-wrapper" style="height: 180px;">
                            <canvas id="quadraChart"></canvas>
                        </div>
                    </div>

                    <div class="card config-card">
                        <h2><i class="fas fa-file-export"></i> Sistema</h2>
                        <button id="downloadFullPdf" class="btn-success"><i class="fas fa-file-pdf"></i> Exportar Tabela PDF</button>
                        <div style="margin-top:10px; padding-top:10px; border-top:1px dashed #ddd;">
                            <button id="backupButton" class="btn-warning"><i class="fas fa-download"></i> Backup Dados</button>
                            <button id="restoreButton" class="btn-outline" style="margin-top:5px;"><i class="fas fa-upload"></i> Restaurar</button>
                            <input type="file" id="restoreFileInput" accept=".json" style="display:none;">
                            <button id="clearButton" class="btn-danger" style="margin-top:5px;"><i class="fas fa-trash"></i> Limpar Tudo</button>
                        </div>
                    </div>
                </div>

                <div class="results-column">
                    <div class="card">
                        <h2><i class="fas fa-list"></i> Catálogo de Lotes</h2>
                        <div class="search-bar">
                            <input type="text" id="searchLote" class="search-input" placeholder="Buscar Lote (ex: 10)...">
                            <input type="text" id="searchQuadra" class="search-input" placeholder="Quadra (ex: A)...">
                            <select id="filterStatus" class="search-input">
                                <option value="todos">Todos Status</option>
                                <option value="disponivel">Disponíveis</option>
                                <option value="vendido">Vendidos</option>
                            </select>
                            <select id="sortSelect" class="search-input">
                                <option value="quadra">Ordem: Quadra/Lote</option>
                                <option value="valor">Ordem: Valor Crescente</option>
                            </select>
                        </div>
                        <div id="resultsContainer">
                            <div style="grid-column:1/-1; text-align:center; padding:40px; color:#aaa;">
                                <i class="fas fa-folder-open" style="font-size:3rem; margin-bottom:15px; opacity:0.5;"></i>
                                <p>Importe o PDF da tabela de preços ou restaure um backup para começar.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-content" id="clientes-tab">
            <div class="card">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                    <h2 style="margin:0; border:none;"><i class="fas fa-users"></i> Carteira de Clientes</h2>
                    <button id="novoClienteBtn" class="btn-primary" style="width: auto;"><i class="fas fa-plus"></i> Novo Cliente</button>
                </div>
                <div class="search-bar">
                    <input type="text" id="searchCliente" class="search-input" placeholder="Buscar cliente por nome, email...">
                    <select id="filterClienteImobiliaria" class="search-input">
                        <option value="todos">Todas Imobiliárias</option>
                    </select>
                </div>
                <div id="clientesContainer" class="clientes-grid">
                    </div>
            </div>
        </div>

        <div class="tab-content" id="imobiliarias-tab">
            <div class="card">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                    <h2 style="margin:0; border:none;"><i class="fas fa-building"></i> Imobiliárias Parceiras</h2>
                    <button id="novaImobiliariaBtn" class="btn-primary" style="width: auto;"><i class="fas fa-plus"></i> Cadastrar Imobiliária</button>
                </div>
                <div class="search-bar">
                    <input type="text" id="searchImobiliaria" class="search-input" placeholder="Buscar imobiliária...">
                </div>
                <div id="imobiliariasContainer" class="imobiliarias-grid">
                    </div>
            </div>
        </div>

        <div class="tab-content" id="relatorios-tab">
            <div class="main-grid">
                <div class="controls-column">
                     <div class="card">
                        <h2><i class="fas fa-trophy"></i> Ranking de Vendas</h2>
                        <div id="rankingImobiliarias">
                            </div>
                    </div>
                </div>
                <div class="results-column">
                    <div class="card">
                        <h2><i class="fas fa-file-invoice"></i> Central de Relatórios</h2>
                        <div class="relatorios-grid">
                            <div class="relatorio-card">
                                <div style="text-align:center; margin-bottom:10px; font-size:2rem; color:var(--primary-color);"><i class="fas fa-chart-bar"></i></div>
                                <h3 style="text-align:center; font-size:1rem; margin-bottom:5px;">Desempenho Imobiliárias</h3>
                                <p style="text-align:center; font-size:0.8rem; color:#666; margin-bottom:15px;">Vendas e comissões por parceiro.</p>
                                <button class="btn-primary" id="downloadRelatorioImobiliarias"><i class="fas fa-download"></i> Baixar PDF</button>
                            </div>
                            
                            <div class="relatorio-card">
                                <div style="text-align:center; margin-bottom:10px; font-size:2rem; color:var(--primary-color);"><i class="fas fa-user-tie"></i></div>
                                <h3 style="text-align:center; font-size:1rem; margin-bottom:5px;">Corretores</h3>
                                <p style="text-align:center; font-size:0.8rem; color:#666; margin-bottom:15px;">Performance individual de corretores.</p>
                                <button class="btn-primary" id="downloadRelatorioCorretores"><i class="fas fa-download"></i> Baixar PDF</button>
                            </div>

                            <div class="relatorio-card">
                                <div style="text-align:center; margin-bottom:10px; font-size:2rem; color:var(--primary-color);"><i class="fas fa-money-bill-wave"></i></div>
                                <h3 style="text-align:center; font-size:1rem; margin-bottom:5px;">Financeiro Geral</h3>
                                <p style="text-align:center; font-size:0.8rem; color:#666; margin-bottom:15px;">VGV Total, Vendido e Disponível.</p>
                                <button class="btn-primary" id="downloadRelatorioFinanceiro"><i class="fas fa-download"></i> Baixar PDF</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <div class="modal-overlay" id="detailModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Detalhes do Lote</h3>
                <button class="close-modal" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="detail-grid">
                    <div class="detail-item"><span class="detail-label">Quadra / Lote</span><span class="detail-value" id="mQuadraLote">-</span></div>
                    <div class="detail-item"><span class="detail-label">ID Tabela</span><span class="detail-value" id="mItem">-</span></div>
                    <div class="detail-item"><span class="detail-label">Área</span><span class="detail-value" id="mTam">-</span></div>
                    <div class="detail-item"><span class="detail-label">Valor m²</span><span class="detail-value" id="mM2">-</span></div>
                    
                    <div class="detail-item" style="grid-column: 1/-1; background: #e8f5e9; border:1px solid #c8e6c9;">
                        <span class="detail-label">Valor Total</span>
                        <span class="detail-value" id="mTotal" style="font-size:1.2rem; color:#2e7d32;">-</span>
                    </div>
                    
                    <div class="detail-item"><span class="detail-label">Sinal</span><span class="detail-value" id="mSinal">-</span></div>
                    <div class="detail-item"><span class="detail-label">Saldo à Vista</span><span class="detail-value" id="mSaldoVista">-</span></div>
                    <div class="detail-item"><span class="detail-label">60x Mensais</span><span class="detail-value" id="mSaldo60">-</span></div>
                    <div class="detail-item"><span class="detail-label">120x Mensais</span><span class="detail-value" id="m120">-</span></div>
                </div>
                <div style="margin-top: 20px; text-align:center;">
                    <button id="downloadFichaButton" class="btn-success" style="width: auto; display:inline-flex;">
                        <i class="fas fa-print"></i> Gerar Ficha Técnica
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="clienteModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="clienteModalTitle">Novo Cliente</h3>
                <button class="close-modal" onclick="closeClienteModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="warning-message" style="background:#fff3cd; padding:10px; border-radius:6px; margin-bottom:15px; font-size:0.85rem; color:#856404;">
                    <i class="fas fa-info-circle"></i> Ao salvar um cliente vinculado a um lote, o lote será automaticamente marcado como <strong>VENDIDO</strong>.
                </div>
                
                <div class="form-group">
                    <label class="form-label">Nome Completo *</label>
                    <input type="text" id="clienteNome" class="form-control">
                </div>
                <div class="form-group" style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                    <div>
                        <label class="form-label">Telefone</label>
                        <input type="text" id="clienteTelefone" class="form-control">
                    </div>
                    <div>
                        <label class="form-label">Email</label>
                        <input type="email" id="clienteEmail" class="form-control">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Imobiliária Parceira</label>
                    <select id="clienteImobiliaria" class="form-control">
                        <option value="">Venda Direta (Sem Imobiliária)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Corretor</label>
                    <input type="text" id="clienteCorretor" class="form-control">
                </div>
                <div class="form-group">
                    <label class="form-label">Lote de Interesse (Apenas Disponíveis) *</label>
                    <select id="clienteLote" class="form-control">
                        <option value="">Selecione...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Observações</label>
                    <textarea id="clienteObservacoes" class="form-control"></textarea>
                </div>
                <div style="margin-top: 20px; display: flex; gap: 10px;">
                    <button id="salvarCliente" class="btn-success"><i class="fas fa-check"></i> Confirmar Venda</button>
                    <button class="btn-outline" onclick="closeClienteModal()">Cancelar</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="imobiliariaModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="imobiliariaModalTitle">Nova Imobiliária</h3>
                <button class="close-modal" onclick="closeImobiliariaModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Nome Fantasia *</label>
                    <input type="text" id="imobiliariaNome" class="form-control">
                </div>
                <div class="form-group">
                    <label class="form-label">Responsável / Gerente</label>
                    <input type="text" id="imobiliariaResponsavel" class="form-control">
                </div>
                <div class="form-group">
                    <label class="form-label">Comissão (%)</label>
                    <input type="number" id="imobiliariaComissao" class="form-control" placeholder="Ex: 5" step="0.1">
                </div>
                <div class="form-group" style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                    <div>
                        <label class="form-label">Telefone</label>
                        <input type="text" id="imobiliariaTelefone" class="form-control">
                    </div>
                    <div>
                        <label class="form-label">CNPJ</label>
                        <input type="text" id="imobiliariaCnpj" class="form-control">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" id="imobiliariaEmail" class="form-control">
                </div>
                <div style="margin-top: 20px; display: flex; gap: 10px;">
                    <button id="salvarImobiliaria" class="btn-success"><i class="fas fa-save"></i> Salvar</button>
                    <button class="btn-outline" onclick="closeImobiliariaModal()">Cancelar</button>
                </div>
            </div>
        </div>
    </div>

    <div id="printFicha" class="print-ficha">
        <div class="ficha-print-header">
            <h1 class="ficha-print-title">Reserva da Foz</h1>
            <p>Ficha Técnica do Lote</p>
        </div>
        
        <div class="ficha-print-highlight">
            <h2 style="margin:0; color:#1b4d3e; font-size:28px;" id="fichaQuadraLote">Quadra X - Lote Y</h2>
            <p id="fichaStatusBadge" style="margin-top:5px; font-weight:bold;">DISPONÍVEL</p>
        </div>

        <div class="ficha-print-grid">
            <div class="ficha-print-item">
                <span class="ficha-print-label">Área Total</span>
                <span class="ficha-print-value" id="fichaArea">- m²</span>
            </div>
            <div class="ficha-print-item">
                <span class="ficha-print-label">Valor Total</span>
                <span class="ficha-print-value" id="fichaValorTotal">-</span>
            </div>
            <div class="ficha-print-item">
                <span class="ficha-print-label">Sinal</span>
                <span class="ficha-print-value" id="fichaSinal">-</span>
            </div>
            <div class="ficha-print-item">
                <span class="ficha-print-label">Saldo em 60x</span>
                <span class="ficha-print-value" id="fichaSaldo60">-</span>
            </div>
            <div class="ficha-print-item">
                <span class="ficha-print-label">Saldo em 120x</span>
                <span class="ficha-print-value" id="ficha120">-</span>
            </div>
             <div class="ficha-print-item">
                <span class="ficha-print-label">Valor m²</span>
                <span class="ficha-print-value" id="fichaM2">-</span>
            </div>
        </div>

        <div class="ficha-print-footer">
            <p>Documento gerado em <span id="fichaGeradoEm"></span>. Valores sujeitos a alteração sem aviso prévio.</p>
        </div>
    </div>

    <div id="printFichaCliente" class="print-ficha">
        <div class="ficha-print-header">
            <h1 class="ficha-print-title">Reserva da Foz</h1>
            <p>Ficha de Reserva / Venda</p>
        </div>
        
        <h3 style="border-bottom: 2px solid #1b4d3e; padding-bottom:5px; margin-bottom:15px;">Dados do Cliente</h3>
        <div class="ficha-print-grid">
            <div class="ficha-print-item">
                <span class="ficha-print-label">Nome</span>
                <span class="ficha-print-value" id="fichaClienteNome">-</span>
            </div>
            <div class="ficha-print-item">
                <span class="ficha-print-label">Telefone</span>
                <span class="ficha-print-value" id="fichaClienteTelefone">-</span>
            </div>
            <div class="ficha-print-item">
                <span class="ficha-print-label">Email</span>
                <span class="ficha-print-value" id="fichaClienteEmail">-</span>
            </div>
            <div class="ficha-print-item">
                <span class="ficha-print-label">Data Cadastro</span>
                <span class="ficha-print-value" id="fichaClienteData">-</span>
            </div>
        </div>

        <h3 style="border-bottom: 2px solid #1b4d3e; padding-bottom:5px; margin-bottom:15px;">Dados do Imóvel</h3>
        <div class="ficha-print-grid">
            <div class="ficha-print-item">
                <span class="ficha-print-label">Lote</span>
                <span class="ficha-print-value" id="fichaClienteLote">-</span>
            </div>
            <div class="ficha-print-item">
                <span class="ficha-print-label">Valor Negociado</span>
                <span class="ficha-print-value" id="fichaClienteValor">-</span>
            </div>
        </div>

        <div style="margin-top:20px; background:#eee; padding:15px; border-radius:6px;">
            <span class="ficha-print-label">Observações</span>
            <p id="fichaClienteObservacoes" style="font-size:12px; margin-top:5px;">-</p>
        </div>

        <div class="ficha-print-footer">
            <p>Documento interno. Gerado em <span id="fichaClienteGeradoEm"></span>.</p>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // ================= STATE =================
            let database = [];
            let clientes = [];
            let imobiliarias = [];
            let charts = {};
            let currentLote = null;
            let currentCliente = null;
            let editingClienteId = null;
            let editingImobiliariaId = null;
            let simplifiedMode = localStorage.getItem('simplifiedMode') === 'true';

            // ================= INIT FUNCTIONS =================
            function init() {
                initTabs();
                initCharts();
                initSimplifiedMode();
                
                // Load Data
                const dbSaved = localStorage.getItem('reservaFoz_db_final');
                const cliSaved = localStorage.getItem('reservaFoz_clientes_final');
                const imoSaved = localStorage.getItem('reservaFoz_imos_final');

                if (dbSaved) database = JSON.parse(dbSaved);
                if (cliSaved) clientes = JSON.parse(cliSaved);
                if (imoSaved) imobiliarias = JSON.parse(imoSaved);

                // Initial Render
                saveAndRender();
                renderClientes();
                renderImobiliarias();
                updateImobiliariaSelect(); // Populando o dropdown na carga inicial
                atualizarRankings();
            }

            function initTabs() {
                document.querySelectorAll('.tab').forEach(tab => {
                    tab.addEventListener('click', () => {
                        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                        
                        tab.classList.add('active');
                        document.getElementById(`${tab.dataset.tab}-tab`).classList.add('active');
                        
                        if (tab.dataset.tab === 'relatorios') atualizarRankings();
                    });
                });
            }

            function initSimplifiedMode() {
                const toggle = document.getElementById('simplifiedModeToggle');
                const mainGrid = document.getElementById('mainGrid');
                const configCards = document.querySelectorAll('.config-card');
                
                toggle.checked = simplifiedMode;
                
                function applyMode() {
                    if (simplifiedMode) {
                        mainGrid.classList.add('simplified');
                        configCards.forEach(card => card.classList.add('hidden'));
                    } else {
                        mainGrid.classList.remove('simplified');
                        configCards.forEach(card => card.classList.remove('hidden'));
                    }
                }
                applyMode();

                toggle.addEventListener('change', (e) => {
                    simplifiedMode = e.target.checked;
                    localStorage.setItem('simplifiedMode', simplifiedMode);
                    applyMode();
                });
            }

            function initCharts() {
                const ctxQty = document.getElementById('quantityChart').getContext('2d');
                charts.qty = new Chart(ctxQty, {
                    type: 'doughnut',
                    data: {
                        labels: ['Disponíveis', 'Vendidos'],
                        datasets: [{ data: [0,0], backgroundColor: ['#40916c', '#bc4749'], borderWidth: 0 }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, cutout: '65%', plugins: { legend: { display: false } } }
                });

                const ctxQuadra = document.getElementById('quadraChart').getContext('2d');
                charts.quadra = new Chart(ctxQuadra, {
                    type: 'bar',
                    data: { labels: [], datasets: [{ label: 'Disp', data: [], backgroundColor: '#2d6a4f', borderRadius: 4 }] },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { grid: { display: false } } } }
                });
            }

            // ================= CORE LOGIC =================
            function saveAndRender() {
                // Save
                localStorage.setItem('reservaFoz_db_final', JSON.stringify(database));
                
                // Update Stats
                const sold = database.filter(l => l.status === 'vendido').length;
                const avail = database.length - sold;
                
                document.getElementById('totalCount').innerText = database.length;
                document.getElementById('availCount').innerText = avail;
                document.getElementById('soldCount').innerText = sold;

                // Update Charts
                charts.qty.data.datasets[0].data = [avail, sold];
                charts.qty.update();

                const quadraCounts = {};
                database.filter(l => l.status === 'disponivel').forEach(l => {
                    quadraCounts[l.qd] = (quadraCounts[l.qd] || 0) + 1;
                });
                const sortedQuadras = Object.keys(quadraCounts).sort();
                charts.quadra.data.labels = sortedQuadras;
                charts.quadra.data.datasets[0].data = sortedQuadras.map(q => quadraCounts[q]);
                charts.quadra.update();

                // Update Avg Price
                const totals = database.map(l => parseMoney(l.total));
                const avg = totals.length ? totals.reduce((a,b)=>a+b,0)/totals.length : 0;
                document.getElementById('avgTotalValue').innerText = formatMoney(avg);

                filterLotes();
            }

            function parseMoney(str) {
                if (!str) return 0;
                return parseFloat(str.replace(/\./g, '').replace(',', '.')) || 0;
            }

            function formatMoney(val) {
                return val.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            }

            function filterLotes() {
                const sLote = document.getElementById('searchLote').value.toLowerCase();
                const sQuadra = document.getElementById('searchQuadra').value.toUpperCase();
                const status = document.getElementById('filterStatus').value;
                const sort = document.getElementById('sortSelect').value;

                let res = database.filter(l => {
                    const match = l.lt.includes(sLote) && (l.qd.includes(sQuadra) || sQuadra === '');
                    if (status === 'todos') return match;
                    return match && l.status === status;
                });

                res.sort((a,b) => {
                    if (sort === 'quadra') return a.qd.localeCompare(b.qd) || parseInt(a.lt) - parseInt(b.lt);
                    if (sort === 'valor') return parseMoney(a.total) - parseMoney(b.total);
                });

                const container = document.getElementById('resultsContainer');
                container.innerHTML = '';
                
                if (res.length === 0 && database.length > 0) container.innerHTML = '<p style="grid-column:1/-1; text-align:center; color:#666;">Nenhum lote encontrado no filtro.</p>';

                res.forEach(l => {
                    const isSold = l.status === 'vendido';
                    const div = document.createElement('div');
                    div.className = `lot-card ${l.status}`;
                    div.onclick = () => openModal(l);
                    div.innerHTML = `
                        <div class="lot-card-header">
                            <strong>Qd ${l.qd} - Lt ${l.lt}</strong>
                            <span class="status-badge">${isSold ? 'VENDIDO' : 'DISPONÍVEL'}</span>
                        </div>
                        <div class="lot-body">
                            <div class="lot-info-row"><span>Área:</span> <b>${l.tam} m²</b></div>
                            <div class="lot-info-row"><span>Total:</span> <b>${l.total}</b></div>
                        </div>
                        <button class="btn-action-card" onclick="event.stopPropagation(); toggleStatus('${l.item}')">
                            ${isSold ? '<i class="fas fa-undo"></i> Liberar' : '<i class="fas fa-check"></i> Vender Rápido'}
                        </button>
                    `;
                    container.appendChild(div);
                });
            }

            window.toggleStatus = function(item) {
                const idx = database.findIndex(l => l.item === item);
                if (idx >= 0) {
                    // Se for marcar como vendido, avisa se já tem cliente? Não, deixa manual.
                    // Se for liberar, remove status vendido.
                    database[idx].status = database[idx].status === 'vendido' ? 'disponivel' : 'vendido';
                    saveAndRender();
                    atualizarRankings();
                }
            };

            // ================= CLIENTS LOGIC =================
            function renderClientes() {
                const container = document.getElementById('clientesContainer');
                const term = document.getElementById('searchCliente').value.toLowerCase();
                const filterImo = document.getElementById('filterClienteImobiliaria').value;
                
                let list = clientes.filter(c => 
                    (c.nome.toLowerCase().includes(term) || c.email.toLowerCase().includes(term)) &&
                    (filterImo === 'todos' || c.imobiliariaId === filterImo)
                );
                
                container.innerHTML = '';
                if(list.length === 0) {
                    container.innerHTML = `<div style="grid-column:1/-1; text-align:center; padding:20px; color:#aaa;">Nenhum cliente encontrado.</div>`;
                    return;
                }

                list.forEach(c => {
                    // Verificar lote atual
                    const lote = database.find(l => l.item === c.loteId);
                    const div = document.createElement('div');
                    div.className = 'cliente-card';
                    div.innerHTML = `
                        <div style="display:flex; justify-content:space-between;">
                            <strong style="color:var(--primary-color); font-size:1rem;">${c.nome}</strong>
                            <span style="font-size:0.7rem; color:#666;">${new Date(c.dataCadastro).toLocaleDateString()}</span>
                        </div>
                        <div style="margin:8px 0; font-size:0.85rem; color:#555;">
                            <div><i class="fas fa-phone"></i> ${c.telefone || '-'}</div>
                            <div><i class="fas fa-building"></i> ${c.imobiliaria || 'Venda Direta'}</div>
                            <div><i class="fas fa-home"></i> <strong>${c.loteInfo}</strong></div>
                        </div>
                        <div style="display:flex; gap:5px; margin-top:10px;">
                            <button class="btn-sm btn-primary" onclick="printCliente('${c.id}')"><i class="fas fa-file-pdf"></i> Ficha</button>
                            <button class="btn-sm btn-outline" onclick="editCliente('${c.id}')"><i class="fas fa-edit"></i></button>
                            <button class="btn-sm btn-danger" onclick="deleteCliente('${c.id}')"><i class="fas fa-trash"></i></button>
                        </div>
                    `;
                    container.appendChild(div);
                });
            }

            document.getElementById('salvarCliente').addEventListener('click', () => {
                const nome = document.getElementById('clienteNome').value;
                const loteId = document.getElementById('clienteLote').value;
                const imobId = document.getElementById('clienteImobiliaria').value;
                
                if(!nome || !loteId) return alert('Nome e Lote são obrigatórios.');
                
                const lote = database.find(l => l.item === loteId);
                const imobiliaria = imobiliarias.find(i => i.id === imobId);
                const imobNome = imobiliaria ? imobiliaria.nome : 'Venda Direta';

                const obj = {
                    id: editingClienteId || Date.now().toString(),
                    nome,
                    telefone: document.getElementById('clienteTelefone').value,
                    email: document.getElementById('clienteEmail').value,
                    imobiliariaId: imobId,
                    imobiliaria: imobNome,
                    corretor: document.getElementById('clienteCorretor').value,
                    loteId,
                    loteInfo: `Qd ${lote.qd} - Lt ${lote.lt}`,
                    observacoes: document.getElementById('clienteObservacoes').value,
                    dataCadastro: new Date().toISOString()
                };

                if(editingClienteId) {
                    const idx = clientes.findIndex(c => c.id === editingClienteId);
                    clientes[idx] = obj;
                    alert('Cliente atualizado!');
                } else {
                    clientes.push(obj);
                    // AUTOMATICAMENTE MARCA COMO VENDIDO
                    lote.status = 'vendido'; 
                    saveAndRender(); // Salva o lote como vendido
                    alert('Cliente salvo e lote marcado como VENDIDO!');
                }

                localStorage.setItem('reservaFoz_clientes_final', JSON.stringify(clientes));
                renderClientes();
                closeClienteModal();
                atualizarRankings();
            });

            // ================= IMOBILIARIAS LOGIC =================
            function renderImobiliarias() {
                const container = document.getElementById('imobiliariasContainer');
                const term = document.getElementById('searchImobiliaria').value.toLowerCase();
                
                let list = imobiliarias.filter(i => i.nome.toLowerCase().includes(term));
                container.innerHTML = '';
                
                if(list.length === 0) {
                    container.innerHTML = `<div style="grid-column:1/-1; text-align:center; padding:20px; color:#aaa;">Nenhuma imobiliária cadastrada.</div>`;
                    return;
                }

                list.forEach(i => {
                    // Stats rápidos
                    const vendas = clientes.filter(c => c.imobiliariaId === i.id).length;
                    
                    const div = document.createElement('div');
                    div.className = 'imobiliaria-card';
                    div.innerHTML = `
                        <div style="display:flex; justify-content:space-between;">
                            <strong style="color:var(--secondary-color); font-size:1rem;">${i.nome}</strong>
                            <span style="font-size:0.7rem; background:#eee; padding:2px 6px; border-radius:4px;">${vendas} Vendas</span>
                        </div>
                        <div style="margin:8px 0; font-size:0.85rem; color:#555;">
                            <div><i class="fas fa-user"></i> ${i.responsavel || '-'}</div>
                            <div><i class="fas fa-percent"></i> Comissão: ${i.comissao || 0}%</div>
                            <div><i class="fas fa-phone"></i> ${i.telefone || '-'}</div>
                        </div>
                        <div style="display:flex; gap:5px; margin-top:10px;">
                            <button class="btn-sm btn-outline" onclick="editImobiliaria('${i.id}')"><i class="fas fa-edit"></i> Editar</button>
                            <button class="btn-sm btn-danger" onclick="deleteImobiliaria('${i.id}')"><i class="fas fa-trash"></i> Excluir</button>
                        </div>
                    `;
                    container.appendChild(div);
                });
            }

            document.getElementById('salvarImobiliaria').addEventListener('click', () => {
                const nome = document.getElementById('imobiliariaNome').value;
                if(!nome) return alert('Nome é obrigatório');

                const obj = {
                    id: editingImobiliariaId || Date.now().toString(),
                    nome,
                    responsavel: document.getElementById('imobiliariaResponsavel').value,
                    comissao: document.getElementById('imobiliariaComissao').value,
                    telefone: document.getElementById('imobiliariaTelefone').value,
                    cnpj: document.getElementById('imobiliariaCnpj').value,
                    email: document.getElementById('imobiliariaEmail').value,
                    dataCadastro: new Date().toISOString()
                };

                if(editingImobiliariaId) {
                    const idx = imobiliarias.findIndex(i => i.id === editingImobiliariaId);
                    imobiliarias[idx] = obj;
                } else {
                    imobiliarias.push(obj);
                }

                localStorage.setItem('reservaFoz_imos_final', JSON.stringify(imobiliarias));
                renderImobiliarias();
                updateImobiliariaSelect();
                closeImobiliariaModal();
            });

            function updateImobiliariaSelect() {
                const sel = document.getElementById('clienteImobiliaria');
                const filter = document.getElementById('filterClienteImobiliaria');
                
                sel.innerHTML = '<option value="">Venda Direta (Sem Imobiliária)</option>';
                filter.innerHTML = '<option value="todos">Todas Imobiliárias</option>';
                
                imobiliarias.forEach(i => {
                    const opt = `<option value="${i.id}">${i.nome}</option>`;
                    sel.innerHTML += opt;
                    filter.innerHTML += opt;
                });
            }

            // ================= MODAL HELPERS =================
            window.openModal = function(lote) {
                currentLote = lote;
                const setText = (id, val) => document.getElementById(id).innerText = val || '-';
                
                setText('mQuadraLote', `${lote.qd} / ${lote.lt}`);
                setText('mItem', lote.item);
                setText('mTam', lote.tam + ' m²');
                setText('mM2', lote.m2);
                setText('mTotal', lote.total);
                setText('mSinal', lote.sinal);
                setText('mSaldoVista', lote.saldoVista);
                setText('mSaldo60', lote.saldo60);
                setText('m120', lote.p120);

                document.getElementById('detailModal').style.display = 'flex';
            };

            window.closeModal = () => document.getElementById('detailModal').style.display = 'none';

            window.closeClienteModal = () => {
                document.getElementById('clienteModal').style.display = 'none';
                editingClienteId = null;
                document.getElementById('clienteNome').value = '';
                // limpar outros inputs...
            };
            
            window.closeImobiliariaModal = () => {
                document.getElementById('imobiliariaModal').style.display = 'none';
                editingImobiliariaId = null;
                document.getElementById('imobiliariaNome').value = '';
            };

            document.getElementById('novoClienteBtn').addEventListener('click', () => {
                // Popular lotes disponíveis apenas
                const sel = document.getElementById('clienteLote');
                sel.innerHTML = '<option value="">Selecione...</option>';
                database.filter(l => l.status === 'disponivel').forEach(l => {
                    sel.innerHTML += `<option value="${l.item}">Qd ${l.qd} - Lt ${l.lt} (${l.total})</option>`;
                });
                document.getElementById('clienteModal').style.display = 'flex';
            });

            document.getElementById('novaImobiliariaBtn').addEventListener('click', () => {
                document.getElementById('imobiliariaModal').style.display = 'flex';
            });

            // ================= EDIT / DELETE HELPERS =================
            window.editCliente = (id) => {
                const c = clientes.find(x => x.id === id);
                if(!c) return;
                editingClienteId = id;
                document.getElementById('clienteNome').value = c.nome;
                document.getElementById('clienteTelefone').value = c.telefone;
                document.getElementById('clienteEmail').value = c.email;
                document.getElementById('clienteImobiliaria').value = c.imobiliariaId;
                document.getElementById('clienteCorretor').value = c.corretor;
                document.getElementById('clienteObservacoes').value = c.observacoes;
                
                // Lote: adicionar a opção mesmo se vendido, para poder editar
                const sel = document.getElementById('clienteLote');
                sel.innerHTML = `<option value="${c.loteId}" selected>${c.loteInfo}</option>`;
                database.filter(l => l.status === 'disponivel').forEach(l => {
                    sel.innerHTML += `<option value="${l.item}">Qd ${l.qd} - Lt ${l.lt}</option>`;
                });
                
                document.getElementById('clienteModal').style.display = 'flex';
            };

            window.deleteCliente = (id) => {
                if(confirm('Excluir cliente?')) {
                    clientes = clientes.filter(c => c.id !== id);
                    localStorage.setItem('reservaFoz_clientes_final', JSON.stringify(clientes));
                    renderClientes();
                    atualizarRankings();
                }
            };

            window.editImobiliaria = (id) => {
                const i = imobiliarias.find(x => x.id === id);
                editingImobiliariaId = id;
                document.getElementById('imobiliariaNome').value = i.nome;
                document.getElementById('imobiliariaResponsavel').value = i.responsavel;
                document.getElementById('imobiliariaComissao').value = i.comissao;
                document.getElementById('imobiliariaTelefone').value = i.telefone;
                document.getElementById('imobiliariaCnpj').value = i.cnpj;
                document.getElementById('imobiliariaEmail').value = i.email;
                document.getElementById('imobiliariaModal').style.display = 'flex';
            };

            window.deleteImobiliaria = (id) => {
                if(confirm('Excluir imobiliária? Clientes vinculados perderão a referência.')) {
                    imobiliarias = imobiliarias.filter(i => i.id !== id);
                    // Limpar referência nos clientes
                    clientes.forEach(c => { if(c.imobiliariaId === id) { c.imobiliariaId = ''; c.imobiliaria = 'Ex-Parceiro'; }});
                    
                    localStorage.setItem('reservaFoz_imos_final', JSON.stringify(imobiliarias));
                    localStorage.setItem('reservaFoz_clientes_final', JSON.stringify(clientes));
                    renderImobiliarias();
                    renderClientes();
                }
            };

            // ================= PRINT / PDF LOGIC =================
            window.printCliente = async (id) => {
                const c = clientes.find(x => x.id === id);
                const l = database.find(x => x.item === c.loteId);
                
                document.getElementById('fichaClienteNome').innerText = c.nome;
                document.getElementById('fichaClienteTelefone').innerText = c.telefone;
                document.getElementById('fichaClienteEmail').innerText = c.email;
                document.getElementById('fichaClienteData').innerText = new Date(c.dataCadastro).toLocaleDateString();
                document.getElementById('fichaClienteLote').innerText = c.loteInfo;
                document.getElementById('fichaClienteValor').innerText = l ? l.total : '-';
                document.getElementById('fichaClienteObservacoes').innerText = c.observacoes || 'Sem observações.';
                document.getElementById('fichaClienteGeradoEm').innerText = new Date().toLocaleString();

                generatePdfFromDiv('printFichaCliente', `Ficha_${c.nome}.pdf`);
            };

            document.getElementById('downloadFichaButton').addEventListener('click', () => {
                if(!currentLote) return;
                
                // Preencher template
                const l = currentLote;
                const isSold = l.status === 'vendido';
                document.getElementById('fichaQuadraLote').innerText = `Quadra ${l.qd} - Lote ${l.lt}`;
                document.getElementById('fichaStatusBadge').innerText = isSold ? 'VENDIDO' : 'DISPONÍVEL';
                document.getElementById('fichaStatusBadge').style.color = isSold ? '#bc4749' : '#40916c';
                document.getElementById('fichaArea').innerText = l.tam + ' m²';
                document.getElementById('fichaValorTotal').innerText = l.total;
                document.getElementById('fichaSinal').innerText = l.sinal;
                document.getElementById('fichaSaldo60').innerText = l.saldo60;
                document.getElementById('ficha120').innerText = l.p120;
                document.getElementById('fichaM2').innerText = l.m2;
                document.getElementById('fichaGeradoEm').innerText = new Date().toLocaleString();

                generatePdfFromDiv('printFicha', `Lote_${l.qd}_${l.lt}.pdf`);
            });

            async function generatePdfFromDiv(divId, filename) {
                const element = document.getElementById(divId);
                element.style.display = 'block'; // Mostrar p/ renderizar
                
                try {
                    const canvas = await html2canvas(element, { scale: 2, backgroundColor: '#ffffff' });
                    element.style.display = 'none'; // Esconder
                    
                    const imgData = canvas.toDataURL('image/png');
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF('p', 'mm', 'a4');
                    const width = 190;
                    const height = canvas.height * width / canvas.width;
                    
                    doc.addImage(imgData, 'PNG', 10, 10, width, height);
                    doc.save(filename);
                } catch (e) {
                    alert('Erro ao gerar PDF: ' + e.message);
                    element.style.display = 'none';
                }
            }

            // ================= RELATORIOS =================
            function atualizarRankings() {
                const container = document.getElementById('rankingImobiliarias');
                
                // Calcular vendas por Imob
                const ranking = imobiliarias.map(i => {
                    const vendas = clientes.filter(c => c.imobiliariaId === i.id);
                    const totalVendas = vendas.reduce((acc, c) => {
                        const l = database.find(lot => lot.item === c.loteId);
                        return acc + (l ? parseMoney(l.total) : 0);
                    }, 0);
                    return { nome: i.nome, qtd: vendas.length, total: totalVendas };
                }).sort((a,b) => b.total - a.total);

                if(ranking.length === 0) {
                    container.innerHTML = '<div style="text-align:center; color:#aaa; padding:10px;">Sem dados.</div>';
                    return;
                }

                container.innerHTML = '';
                ranking.slice(0, 5).forEach((r, idx) => {
                    container.innerHTML += `
                        <div class="ranking-item">
                            <div style="display:flex; align-items:center; gap:10px;">
                                <div class="ranking-position">${idx+1}</div>
                                <div>
                                    <div style="font-weight:bold; font-size:0.9rem;">${r.nome}</div>
                                    <div style="font-size:0.75rem; color:#666;">${r.qtd} Vendas</div>
                                </div>
                            </div>
                            <div style="font-weight:bold; color:var(--primary-color);">${formatMoney(r.total)}</div>
                        </div>
                    `;
                });
            }

            document.getElementById('downloadRelatorioImobiliarias').addEventListener('click', () => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                doc.setFontSize(16); doc.text("Relatório de Performance - Imobiliárias", 14, 20);
                
                const data = imobiliarias.map(i => {
                    const vendas = clientes.filter(c => c.imobiliariaId === i.id);
                    const total = vendas.reduce((acc, c) => {
                        const l = database.find(lot => lot.item === c.loteId);
                        return acc + (l ? parseMoney(l.total) : 0);
                    }, 0);
                    const comissao = total * (parseFloat(i.comissao)||0) / 100;
                    return [i.nome, vendas.length, formatMoney(total), formatMoney(comissao)];
                });

                doc.autoTable({
                    head: [['Imobiliária', 'Qtd Vendas', 'VGV Total', 'Comissão Estimada']],
                    body: data,
                    startY: 30,
                    headStyles: { fillColor: [27, 77, 62] }
                });
                doc.save('Relatorio_Imobiliarias.pdf');
            });

            document.getElementById('downloadRelatorioCorretores').addEventListener('click', () => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                doc.setFontSize(16); doc.text("Relatório de Vendas por Corretor", 14, 20);
                
                // Agrupar por corretor
                const corretores = {};
                clientes.forEach(c => {
                    const nome = c.corretor || 'Não Informado';
                    const l = database.find(lot => lot.item === c.loteId);
                    const val = l ? parseMoney(l.total) : 0;
                    
                    if(!corretores[nome]) corretores[nome] = { qtd: 0, total: 0 };
                    corretores[nome].qtd++;
                    corretores[nome].total += val;
                });

                const data = Object.keys(corretores).map(k => [k, corretores[k].qtd, formatMoney(corretores[k].total)]);

                doc.autoTable({
                    head: [['Corretor', 'Vendas', 'VGV Total']],
                    body: data,
                    startY: 30,
                    headStyles: { fillColor: [27, 77, 62] }
                });
                doc.save('Relatorio_Corretores.pdf');
            });

            document.getElementById('downloadRelatorioFinanceiro').addEventListener('click', () => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                doc.setFontSize(16); doc.text("Relatório Financeiro Geral", 14, 20);

                const totalLotes = database.length;
                const vendidos = database.filter(l => l.status === 'vendido');
                const disponiveis = database.filter(l => l.status === 'disponivel');

                const vgvTotal = database.reduce((a,b) => a + parseMoney(b.total), 0);
                const vgvVendido = vendidos.reduce((a,b) => a + parseMoney(b.total), 0);
                const vgvDisp = disponiveis.reduce((a,b) => a + parseMoney(b.total), 0);

                doc.setFontSize(12);
                doc.text(`Total de Lotes: ${totalLotes}`, 14, 35);
                doc.text(`Vendidos: ${vendidos.length} (${((vendidos.length/totalLotes)*100).toFixed(1)}%)`, 14, 42);
                doc.text(`Disponíveis: ${disponiveis.length}`, 14, 49);
                
                doc.text(`VGV Potencial Total: ${formatMoney(vgvTotal)}`, 14, 60);
                doc.text(`VGV Realizado (Vendido): ${formatMoney(vgvVendido)}`, 14, 67);
                doc.text(`VGV Estoque: ${formatMoney(vgvDisp)}`, 14, 74);

                doc.save('Relatorio_Financeiro.pdf');
            });

            // ================= PDF IMPORT & PARSING =================
            document.getElementById('importPdfButton').addEventListener('click', async () => {
                const file = document.getElementById('pdfFileInput').files[0];
                if(!file) return alert('Selecione um PDF.');
                document.getElementById('loadingIndicator').style.display = 'block';
                
                try {
                    const buffer = await file.arrayBuffer();
                    const pdf = await pdfjsLib.getDocument(buffer).promise;
                    let fullText = '';
                    for(let i=1; i<=pdf.numPages; i++) {
                        const page = await pdf.getPage(i);
                        const content = await page.getTextContent();
                        fullText += content.items.map(item => item.str).join(' ') + '\n';
                    }
                    
                    const newData = parseAndLoad(fullText);
                    // Merge status if exists
                    newData.forEach(n => {
                        const old = database.find(o => o.item === n.item);
                        if(old && old.status === 'vendido') n.status = 'vendido';
                    });
                    
                    database = newData;
                    saveAndRender();
                    alert(`${database.length} lotes importados!`);
                } catch(e) {
                    alert('Erro PDF: ' + e.message);
                } finally {
                    document.getElementById('loadingIndicator').style.display = 'none';
                }
            });

            function parseAndLoad(text) {
                const data = [];
                let clean = text.replace(/R\$\s*/gi, '').replace(/\s+/g, ' ');
                
                // Regex ajustada para capturar campos da tabela padrão
                const regex = /(\d+)\s+([A-Z])\s+(\d+)\s+([\d.,]+)\s+([\d.,]+)\s+([\d.,]+)\s+([\d.,]+)\s+([\d.,]+)\s+([\d.,]+)\s+([\d.,]+)\s+([\d.,]+)\s+([\d.,]+)\s+([\d.,]+)\s+([\d.,]+)\s+([\d.,]+)/g;
                let match;
                
                while ((match = regex.exec(clean)) !== null) {
                    data.push({
                        item: match[1], qd: match[2], lt: match[3], tam: match[4], m2: match[5],
                        total: match[6]||'-', sinal: match[7]||'-', sinalVista: match[8]||'-',
                        reserva: match[9]||'-', saldoVista: match[10]||'-', saldo60: match[13]||'-',
                        p120: match[14]||'-', p156: match[15]||'-', p160: match[16]||'-', // índices ajustados approx
                        saldo2x: match[11]||'-', saldo3x: match[12]||'-',
                        status: 'disponivel'
                    });
                }
                return data;
            }

            // ================= LISTENERS DIVERSOS =================
            document.getElementById('searchLote').addEventListener('input', filterLotes);
            document.getElementById('searchQuadra').addEventListener('input', filterLotes);
            document.getElementById('filterStatus').addEventListener('change', filterLotes);
            document.getElementById('sortSelect').addEventListener('change', filterLotes);
            document.getElementById('searchCliente').addEventListener('input', renderClientes);
            document.getElementById('filterClienteImobiliaria').addEventListener('change', renderClientes);
            document.getElementById('searchImobiliaria').addEventListener('input', renderImobiliarias);

            document.getElementById('clearButton').addEventListener('click', () => {
                if(confirm('ATENÇÃO: Isso apagará TUDO (Lotes, Clientes, Imobiliárias). Continuar?')) {
                    localStorage.clear();
                    location.reload();
                }
            });

            // Backup / Restore simples
            document.getElementById('backupButton').addEventListener('click', () => {
                const data = {
                    db: database,
                    cli: clientes,
                    imo: imobiliarias,
                    date: new Date()
                };
                const blob = new Blob([JSON.stringify(data)], {type: 'application/json'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `backup_reserva_${Date.now()}.json`;
                a.click();
            });

            document.getElementById('restoreButton').addEventListener('click', () => document.getElementById('restoreFileInput').click());
            document.getElementById('restoreFileInput').addEventListener('change', (e) => {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = (ev) => {
                    try {
                        const d = JSON.parse(ev.target.result);
                        if(d.db) database = d.db;
                        if(d.cli) clientes = d.cli;
                        if(d.imo) imobiliarias = d.imo;
                        saveAndRender();
                        renderClientes();
                        renderImobiliarias();
                        alert('Dados restaurados!');
                    } catch(err) { alert('Arquivo inválido'); }
                };
                reader.readAsText(file);
            });

            // Start
            init();
        });
    </script>
</body>
</html>
